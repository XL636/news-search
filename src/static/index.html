<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InsightRadar Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;500;600;700&family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Fira Sans', 'system-ui', 'sans-serif'] },
          colors: {
            surface: { 50: '#faf8f5', 100: '#f0ede8', 800: '#272522', 900: '#1f1d1a', 950: '#1a1816' },
          },
        },
      },
    }
  </script>
  <style>
    /* === Design Tokens === */
    :root {
      /* Colors - Background */
      --bg-base: #1a1816;
      --bg-raised: rgba(32, 30, 26, .75);
      --bg-surface: rgba(40, 38, 33, .65);
      --bg-overlay: rgba(48, 45, 38, .55);
      --bg-hover: rgba(48, 45, 38, .85);
      /* Colors - Border */
      --border-subtle: rgba(168,162,150,.08);
      --border-default: rgba(168,162,150,.10);
      --border-strong: rgba(168,162,150,.16);
      --border-accent: rgba(217,119,6,.30);
      /* Colors - Text */
      --text-primary: #ece9e1;
      --text-secondary: #b5b0a6;
      --text-tertiary: #7c7770;
      --text-accent: #fbbf24;
      --accent-warm: #f59e0b;
      /* Elevation System (4-level dimensional layering) */
      --elevation-1: 0 1px 3px rgba(0,0,0,.12), 0 1px 2px rgba(0,0,0,.08);
      --elevation-2: 0 4px 12px rgba(0,0,0,.15), 0 2px 4px rgba(0,0,0,.10);
      --elevation-3: 0 12px 32px rgba(0,0,0,.20), 0 4px 8px rgba(0,0,0,.10);
      --elevation-4: 0 24px 56px rgba(0,0,0,.30), 0 8px 16px rgba(0,0,0,.15);
      /* Legacy shadow aliases */
      --shadow-sm: var(--elevation-1);
      --shadow-md: var(--elevation-2);
      --shadow-lg: var(--elevation-3);
      --shadow-xl: var(--elevation-4);
      --shadow-glow: 0 0 20px rgba(217,119,6,.08);
      --shadow-glow-hover: 0 0 30px rgba(217,119,6,.15);
      /* Radius */
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
      --radius-2xl: 24px;
      /* Easing */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      /* Duration */
      --duration-fast: .15s;
      --duration-normal: .25s;
      --duration-slow: .4s;
    }

    /* === Typography === */
    .text-display { font-size: 28px; font-weight: 800; letter-spacing: -0.03em; line-height: 1.15; }
    .text-heading { font-size: 18px; font-weight: 700; letter-spacing: -0.025em; line-height: 1.3; }
    .card-title { letter-spacing: -0.01em; }
    .text-subheading { font-size: 14px; font-weight: 600; letter-spacing: -0.015em; }
    .text-body { font-size: 14px; font-weight: 400; line-height: 1.65; }
    .text-caption { font-size: 11px; font-weight: 500; letter-spacing: 0.01em; }
    .text-mono { font-family: 'Fira Code', monospace; font-weight: 500; }
    h1, h2, h3, h4 { letter-spacing: -0.025em; }

    /* === Base === */
    body { background: var(--bg-base); color: var(--text-secondary); }
    ::selection { background: rgba(217,119,6,.35); color: #fff; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(168,162,150,.12); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(217,119,6,.2); }

    /* === Noise Texture === */
    body::before { content: ''; position: fixed; inset: 0; z-index: 1; pointer-events: none; opacity: .015; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E"); }

    /* === Glass === */
    .glass { background: var(--bg-raised); backdrop-filter: blur(24px) saturate(180%); border: 1px solid var(--border-subtle); background-image: linear-gradient(to bottom, rgba(255,255,255,.04) 0%, transparent 40%); }
    .glass-light { background: rgba(38, 35, 28, .35); backdrop-filter: blur(12px); border: 1px solid var(--border-subtle); background-image: linear-gradient(to bottom, rgba(255,255,255,.03) 0%, transparent 40%); }

    /* === Cards === */
    .card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); transition: border-color var(--duration-normal) var(--ease-out), box-shadow var(--duration-normal) var(--ease-out), transform var(--duration-normal) var(--ease-out); position: relative; overflow: hidden; box-shadow: var(--elevation-1); }
    .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent 10%, rgba(217,119,6,.15), transparent 90%); pointer-events: none; }
    .card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(217,119,6,.04), transparent 60%); opacity: 0; transition: opacity var(--duration-normal) var(--ease-out); pointer-events: none; z-index: 0; }
    .card:hover { border-color: var(--border-accent); box-shadow: var(--elevation-3), var(--shadow-glow-hover); transform: translateY(-2px) scale(1.005); }
    .card:hover::after { opacity: 1; }
    .card-hot { border-left: 3px solid #ef4444; }
    .card-hot .card-hot-glow { position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(239,68,68,.10) 0%, rgba(239,68,68,.04) 40%, transparent 70%); pointer-events: none; z-index: 0; }

    /* AI Analyze btn: semi-visible by default, full on hover (touch-friendly) */
    .card .btn-ai-analyze { opacity: .45; transition: opacity var(--duration-normal) var(--ease-out), background var(--duration-fast), border-color var(--duration-fast), color var(--duration-fast); }
    .card:hover .btn-ai-analyze, .card .btn-ai-analyze:focus-visible { opacity: 1; }

    /* === Chips === */
    .chip { transition: all var(--duration-normal) var(--ease-out); border-radius: var(--radius-sm); }
    .chip:hover { background: rgba(217,119,6,.1); border-color: rgba(217,119,6,.25); }
    .chip.active { background: linear-gradient(135deg, #fbbf24, #d97706, #b45309); color: #fff; border-color: transparent; box-shadow: 0 2px 12px rgba(217,119,6,.3); }

    /* === KPI Cards (Bento Grid Style) === */
    .kpi-card { background: linear-gradient(135deg, rgba(38,35,28,.6), rgba(22,21,18,.8)); border: 1px solid var(--border-default); border-radius: var(--radius-lg); transition: all var(--duration-normal) var(--ease-out); position: relative; overflow: hidden; box-shadow: var(--elevation-2); background-image: linear-gradient(to bottom, rgba(255,255,255,.03) 0%, transparent 40%); }
    .kpi-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(217,119,6,.08), transparent); opacity: 0; transition: opacity var(--duration-normal) var(--ease-out); pointer-events: none; }
    .kpi-card:hover { border-color: rgba(217,119,6,.25); box-shadow: var(--elevation-3), var(--shadow-glow); transform: translateY(-1px); }
    .kpi-card:hover::before { opacity: 1; }
    .kpi-card .kpi-accent-bar { height: 3px; border-radius: 2px; margin-top: 8px; opacity: .6; }
    .kpi-card .kpi-icon { width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .kpi-value { font-family: 'Fira Code', monospace; letter-spacing: -0.02em; background: linear-gradient(135deg, #ece9e1, #a8a29e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-feature-settings: 'tnum'; }
    .kpi-stagger { opacity: 0; transform: translateY(10px); animation: kpiEnter .5s var(--ease-out) forwards; }
    @keyframes kpiEnter { to { opacity: 1; transform: translateY(0); } }

    /* === Animations === */
    .fade-in { animation: fadeIn var(--duration-slow) var(--ease-out); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .skeleton { background: linear-gradient(90deg, rgba(38,35,28,.5) 25%, rgba(55,50,42,.5) 50%, rgba(38,35,28,.5) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-lg); }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }

    /* Stagger card entry */
    .card-stagger { opacity: 0; transform: translateY(16px); animation: cardEnter var(--duration-slow) var(--ease-out) forwards; }
    @keyframes cardEnter { to { opacity: 1; transform: translateY(0); } }

    /* Heat pulse for hot items */
    @keyframes heatPulse { 0%, 100% { box-shadow: 0 0 0 0 currentColor; } 50% { box-shadow: 0 0 8px 2px currentColor; } }
    .heat-pulse { animation: heatPulse 2s ease-in-out infinite; }

    /* Orb drift */
    @keyframes orbDrift { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(30px, -20px); } 50% { transform: translate(-20px, 15px); } 75% { transform: translate(15px, 25px); } }

    /* === Heat Bar === */
    .heat-bar-bg { height: 2px; border-radius: 2px; background: rgba(38,35,28,.8); }
    .heat-bar-fill { height: 2px; border-radius: 2px; transition: width .8s var(--ease-out); }

    /* === Source Badges === */
    .source-badge { font-size: 10px; padding: 3px 9px; border-radius: 20px; font-weight: 600; letter-spacing: .3px; border: 1px solid rgba(255,255,255,.04); backdrop-filter: blur(4px); }

    /* === Tags === */
    .tag-pill { font-size: 10px; padding: 3px 10px; border-radius: 20px; background: rgba(38,35,28,.6); color: var(--text-secondary); border: 1px solid var(--border-subtle); transition: all var(--duration-fast); backdrop-filter: blur(4px); }
    .tag-pill:hover { border-color: var(--border-default); color: var(--text-primary); background: rgba(48,45,38,.7); }

    /* === Details === */
    .details-content { max-height: 0; overflow: hidden; transition: max-height .3s var(--ease-out); }
    .details-content.open { max-height: 500px; }

    /* === Toast === */
    .toast-enter { animation: toastIn .4s var(--ease-spring); backdrop-filter: blur(12px); box-shadow: var(--elevation-3); }
    @keyframes toastIn { from { opacity: 0; transform: translateX(60px) scale(.9); filter: blur(4px); } to { opacity: 1; transform: translateX(0) scale(1); filter: blur(0); } }
    .toast-exit { animation: toastOut .3s ease forwards; }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(50px) scale(.95); } }

    /* === Button === */
    .btn-ghost { border: 1px solid var(--border-default); background: rgba(38,35,28,.3); color: var(--text-secondary); transition: all var(--duration-normal) var(--ease-out); border-radius: var(--radius-sm); position: relative; overflow: hidden; }
    .btn-ghost::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at center, rgba(217,119,6,.1), transparent 70%); opacity: 0; transition: opacity var(--duration-normal); pointer-events: none; }
    .btn-ghost:hover { border-color: var(--border-accent); color: #fde68a; }
    .btn-ghost:hover::before { opacity: 1; }
    .btn-ghost.active { background: rgba(217,119,6,.15); border-color: rgba(217,119,6,.4); color: var(--text-accent); }

    /* === Lang Toggle === */
    .lang-toggle { background: var(--bg-overlay); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 2px; }
    .lang-btn { transition: all var(--duration-normal) var(--ease-out); border-radius: 6px; }
    .lang-btn.active { background: linear-gradient(135deg, #fbbf24, #d97706, #b45309); color: #fff; box-shadow: 0 1px 6px rgba(217,119,6,.3); }

    /* === Gradient Orbs (ambient background) === */
    .orb { position: fixed; border-radius: 50%; filter: blur(120px); opacity: .12; pointer-events: none; z-index: 0; animation: orbDrift 20s ease-in-out infinite; }
    .orb-1 { width: 600px; height: 600px; background: radial-gradient(circle, #d97706, #92400e); top: -200px; right: -200px; }
    .orb-2 { width: 400px; height: 400px; background: radial-gradient(circle, #92400e, #451a03); bottom: -100px; left: -150px; animation-delay: -10s; animation-direction: reverse; }
    .orb-3 { width: 350px; height: 350px; background: radial-gradient(circle, #f59e0b, #b45309); bottom: -120px; right: -80px; opacity: .06; animation-delay: -5s; }

    /* === Dividers === */
    .divider-gradient { height: 1px; background: linear-gradient(90deg, transparent, var(--border-default), transparent); }
    .divider-accent { height: 1px; background: linear-gradient(90deg, transparent, rgba(217,119,6,.2), transparent); }

    /* === Sidebar domain list === */
    .domain-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; transition: all var(--duration-normal) var(--ease-out); font-size: 13px; color: var(--text-secondary); position: relative; }
    .domain-item::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 2px; height: 0; background: var(--text-accent); border-radius: 1px; transition: height var(--duration-normal) var(--ease-out); }
    .domain-item:hover { background: rgba(217,119,6,.06); color: #fde68a; box-shadow: inset 3px 0 8px -2px rgba(217,119,6,.12); }
    .domain-item.active { background: rgba(217,119,6,.08); color: var(--text-accent); font-weight: 600; }
    .domain-item.active::before { height: 16px; }
    .domain-item .count { font-size: 11px; font-family: 'Fira Code', monospace; background: rgba(38,35,28,.8); padding: 1px 8px; border-radius: var(--radius-sm); color: var(--text-tertiary); transition: all var(--duration-normal); }
    .domain-item.active .count { background: rgba(217,119,6,.15); color: var(--text-accent); }

    /* === Sidebar title === */
    .sidebar-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 600; color: var(--text-tertiary); padding: 6px 10px; background: rgba(38,35,28,.3); backdrop-filter: blur(8px); border-radius: 6px; border: 1px solid var(--border-subtle); }
    .sidebar-separator { height: 1px; background: linear-gradient(90deg, transparent, var(--border-default), transparent); margin: 12px 4px; }

    /* === Tab Navigation === */
    .tab-nav { background: var(--bg-overlay); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); padding: 2px; }
    .tab-btn { transition: all var(--duration-normal) var(--ease-out); border-radius: 6px; padding: 6px 14px; font-size: 12px; font-weight: 500; color: var(--text-secondary); cursor: pointer; white-space: nowrap; }
    .tab-btn:hover { color: #fde68a; }
    .tab-btn.active { background: linear-gradient(135deg, #fbbf24, #d97706, #b45309); color: #fff; box-shadow: 0 2px 12px rgba(217,119,6,.25), inset 0 1px 0 rgba(255,255,255,.15), inset 0 -1px 2px rgba(0,0,0,.1); }

    /* === View Toggle === */
    .view.hidden { display: none !important; }

    /* === AI Search === */
    .ai-hero-icon { width: 64px; height: 64px; border-radius: var(--radius-xl); background: linear-gradient(135deg, #fbbf24, #d97706, #b45309, #92400e); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(217,119,6,.3), 0 0 60px rgba(217,119,6,.12), 0 0 100px rgba(217,119,6,.06); animation: heroFloat 8s ease-in-out infinite; position: relative; }
    .ai-hero-halo { position: absolute; inset: -20px; border-radius: 50%; background: radial-gradient(circle, rgba(217,119,6,.12) 0%, rgba(217,119,6,.06) 40%, transparent 70%); pointer-events: none; animation: heroBreath 4s ease-in-out infinite; }
    .ai-hero-halo-outer { position: absolute; inset: -40px; border-radius: 50%; background: radial-gradient(circle, rgba(251,191,36,.04) 0%, transparent 60%); pointer-events: none; animation: heroBreath 4s ease-in-out infinite 1s; }
    @keyframes heroBreath { 0%, 100% { opacity: .6; transform: scale(1); } 50% { opacity: 1; transform: scale(1.08); } }
    .ai-hero-icon::after { content: ''; position: absolute; inset: -4px; border-radius: 24px; background: linear-gradient(135deg, rgba(217,119,6,.3), transparent); opacity: 0; animation: heroPulse 3s ease-in-out infinite; pointer-events: none; }
    @keyframes heroFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
    @keyframes heroPulse { 0%, 100% { opacity: 0; transform: scale(1); } 50% { opacity: 1; transform: scale(1.08); } }

    .ai-search-box { background: rgba(22,21,18,.6); backdrop-filter: blur(16px); border: 1px solid var(--border-default); border-radius: var(--radius-lg); transition: all var(--duration-normal) var(--ease-out); position: relative; }
    .ai-search-box::before { content: ''; position: absolute; inset: -1px; border-radius: calc(var(--radius-lg) + 1px); background: conic-gradient(from 0deg, transparent 0%, rgba(217,119,6,.3) 25%, transparent 50%, rgba(251,191,36,.2) 75%, transparent 100%); opacity: 0; transition: opacity var(--duration-slow); pointer-events: none; z-index: -1; }
    .ai-search-box:focus-within { border-color: rgba(217,119,6,.4); box-shadow: 0 0 0 3px rgba(217,119,6,.08), 0 0 0 1px rgba(217,119,6,.2), var(--elevation-3); transform: scale(1.01); }
    .ai-search-box:focus-within::before { opacity: 1; animation: searchGlow 3s linear infinite; }
    .ai-search-box.drag-over { border-color: rgba(217,119,6,.5); box-shadow: 0 0 0 3px rgba(217,119,6,.12), 0 0 0 1px rgba(217,119,6,.3), var(--elevation-3); background: rgba(217,119,6,.05); }
    @keyframes searchGlow { to { transform: rotate(360deg); } }
    .ai-search-input { background: transparent; border: none; outline: none; color: var(--text-primary); font-size: 15px; width: 100%; }
    .ai-search-input::placeholder { color: #57534e; }
    .ai-search-btn { background: linear-gradient(135deg, #fbbf24, #d97706, #b45309); color: #fff; border: none; border-radius: var(--radius-md); padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--duration-normal) var(--ease-out); white-space: nowrap; position: relative; overflow: hidden; }
    .ai-search-btn::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,.15), transparent); opacity: 0; transition: opacity var(--duration-fast); pointer-events: none; }
    .ai-search-btn:hover { box-shadow: 0 4px 20px rgba(217,119,6,.4); transform: translateY(-1px); }
    .ai-search-btn:hover::before { opacity: 1; }
    .ai-search-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }

    .suggestion-chip { background: rgba(38,35,28,.4); backdrop-filter: blur(12px); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 8px 18px; font-size: 12px; color: var(--text-secondary); cursor: pointer; transition: all var(--duration-normal) var(--ease-out); background-image: linear-gradient(to bottom, rgba(255,255,255,.02) 0%, transparent 50%); }
    .suggestion-chip:hover { background: rgba(217,119,6,.08); border-color: var(--border-accent); color: #fde68a; transform: translateY(-2px); box-shadow: var(--elevation-2), var(--shadow-glow); }

    /* AI Answer */
    .ai-answer-panel { background: rgba(22,21,18,.5); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); position: relative; overflow: hidden; }
    .ai-answer-panel::before { content: ''; position: absolute; top: 0; left: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, #fbbf24, #d97706, transparent); border-radius: 3px 0 0 3px; pointer-events: none; }
    .ai-answer-panel::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(217,119,6,.15), transparent); pointer-events: none; }
    #ai-answer-content h3 { font-size: 15px; font-weight: 700; color: var(--text-primary); margin: 20px 0 8px 0; letter-spacing: -0.025em; }
    #ai-answer-content h3:first-child { margin-top: 0; }
    #ai-answer-content p { font-size: 14px; line-height: 1.75; color: var(--text-secondary); margin: 8px 0; }
    #ai-answer-content ul { margin: 8px 0; padding-left: 20px; }
    #ai-answer-content li { font-size: 14px; line-height: 1.75; color: var(--text-secondary); margin: 4px 0; }
    #ai-answer-content strong { color: var(--text-primary); }
    #ai-answer-content a { color: var(--text-accent); text-decoration: underline; text-underline-offset: 2px; }

    .citation { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; font-size: 10px; font-weight: 700; font-family: 'Fira Code', monospace; background: rgba(217,119,6,.15); color: var(--text-accent); border: 1px solid rgba(217,119,6,.2); border-radius: 5px; cursor: pointer; vertical-align: super; margin: 0 1px; transition: all var(--duration-fast); line-height: 1; }
    .citation:hover { background: rgba(217,119,6,.35); color: #fff; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(217,119,6,.2); }

    .ai-source-card { background: rgba(38,35,28,.4); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 14px; transition: all var(--duration-normal) var(--ease-out); cursor: pointer; position: relative; overflow: hidden; }
    .ai-source-card::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(217,119,6,.06), transparent); opacity: 0; transition: opacity var(--duration-normal); pointer-events: none; }
    .ai-source-card:hover { border-color: var(--border-accent); box-shadow: var(--shadow-md); }
    .ai-source-card:hover::before { opacity: 1; }
    .ai-source-card.highlight { border-color: rgba(217,119,6,.5); box-shadow: 0 0 0 2px rgba(217,119,6,.15); animation: sourceHighlight .6s var(--ease-out); }
    @keyframes sourceHighlight { from { box-shadow: 0 0 0 4px rgba(217,119,6,.3); } to { box-shadow: 0 0 0 2px rgba(217,119,6,.15); } }
    .ai-source-card.web-source { border-left: 2px solid rgba(59,130,246,.3); }

    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .streaming-cursor { display: inline-block; width: 2px; height: 16px; background: linear-gradient(180deg, var(--text-accent), #d97706); margin-left: 2px; vertical-align: text-bottom; animation: blink .8s step-end infinite; box-shadow: 0 0 8px rgba(251,191,36,.4); }

    /* Loading dots — wave bounce */
    .ai-loading-dots span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #d97706; margin: 0 3px; animation: loadingWave .6s ease-in-out infinite alternate; }
    .ai-loading-dots span:nth-child(1) { animation-delay: 0s; }
    .ai-loading-dots span:nth-child(2) { animation-delay: .15s; }
    .ai-loading-dots span:nth-child(3) { animation-delay: .3s; }
    @keyframes loadingWave { from { transform: translateY(0); } to { transform: translateY(-8px); } }

    /* === AI Analyze Button on Cards === */
    .btn-ai-analyze { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: rgba(217,119,6,.1); color: var(--text-accent); border: 1px solid rgba(217,119,6,.2); cursor: pointer; transition: all var(--duration-fast); font-weight: 600; white-space: nowrap; }
    .btn-ai-analyze:hover { background: rgba(217,119,6,.25); border-color: rgba(217,119,6,.4); color: #fff; }

    /* === AI Analyze Overlay + Slide Panel === */
    #ai-analyze-overlay { position: fixed; inset: 0; z-index: 200; pointer-events: none; opacity: 0; transition: opacity .3s var(--ease-out); }
    #ai-analyze-overlay.open { pointer-events: auto; opacity: 1; }
    #ai-analyze-overlay .overlay-bg { position: absolute; inset: 0; background: rgba(0,0,0,.5); backdrop-filter: blur(4px); }
    #ai-analyze-panel { position: absolute; top: 0; right: 0; width: 480px; max-width: 100vw; height: 100vh; background: var(--bg-base); border-left: 1px solid var(--border-default); transform: translateX(100%); transition: transform .35s var(--ease-out); display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--elevation-4), -20px 0 60px rgba(0,0,0,.4); }
    #ai-analyze-overlay.open #ai-analyze-panel { transform: translateX(0); }
    #ai-analyze-panel-content { flex: 1; overflow-y: auto; padding: 20px 24px; }
    #ai-analyze-panel-content h3 { font-size: 15px; font-weight: 700; color: var(--text-primary); margin: 20px 0 8px 0; letter-spacing: -0.025em; }
    #ai-analyze-panel-content h3:first-child { margin-top: 0; }
    #ai-analyze-panel-content p { font-size: 14px; line-height: 1.75; color: var(--text-secondary); margin: 8px 0; }
    #ai-analyze-panel-content ul { margin: 8px 0; padding-left: 20px; }
    #ai-analyze-panel-content li { font-size: 14px; line-height: 1.75; color: var(--text-secondary); margin: 4px 0; }
    #ai-analyze-panel-content strong { color: var(--text-primary); }

    /* === Lightning Button === */
    .ai-latest-btn { background: transparent; color: var(--text-accent); border: 1px solid rgba(217,119,6,.25); border-radius: var(--radius-md); padding: 10px 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--duration-normal) var(--ease-out); white-space: nowrap; display: flex; align-items: center; gap: 6px; }
    .ai-latest-btn:hover { background: rgba(217,119,6,.1); border-color: rgba(217,119,6,.4); box-shadow: 0 4px 16px rgba(217,119,6,.15), var(--shadow-glow); transform: translateY(-1px); }
    .ai-latest-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }

    /* === Image Search Button === */
    .ai-image-btn { background: transparent; color: var(--text-accent); border: 1px solid rgba(217,119,6,.25); border-radius: var(--radius-md); padding: 10px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--duration-normal) var(--ease-out); white-space: nowrap; display: flex; align-items: center; gap: 5px; }
    .ai-image-btn:hover { background: rgba(217,119,6,.1); border-color: rgba(217,119,6,.4); box-shadow: 0 4px 16px rgba(217,119,6,.15), var(--shadow-glow); transform: translateY(-1px); }
    .ai-image-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }
    .ai-image-btn.has-image { background: rgba(217,119,6,.12); border-color: rgba(217,119,6,.45); box-shadow: 0 0 12px rgba(217,119,6,.15); }

    /* === Image Preview Bar === */
    .ai-image-preview { background: rgba(38,35,28,.35); backdrop-filter: blur(12px); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); padding: 8px 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 12px; background-image: linear-gradient(to bottom, rgba(255,255,255,.03) 0%, transparent 40%); }
    .ai-image-preview img { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border-default); }
    .ai-image-preview .file-info { flex: 1; min-width: 0; }
    .ai-image-preview .file-name { font-size: 12px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ai-image-preview .file-size { font-size: 10px; color: var(--text-tertiary); }
    .ai-image-preview .remove-btn { background: none; border: none; color: var(--text-tertiary); cursor: pointer; padding: 4px; border-radius: 4px; transition: all var(--duration-fast); }
    .ai-image-preview .remove-btn:hover { color: #ef4444; background: rgba(239,68,68,.1); }

    /* === AI Keyword Tags === */
    .ai-keyword-tag { display: inline-block; font-size: 11px; padding: 3px 10px; border-radius: 20px; background: rgba(217,119,6,.1); color: #fbbf24; border: 1px solid rgba(217,119,6,.2); font-weight: 500; margin: 2px 3px; }

    /* === Structured Skeleton === */
    .skeleton-card { background: var(--bg-surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 20px; }
    .skeleton-line { border-radius: 4px; background: linear-gradient(90deg, rgba(38,35,28,.5) 25%, rgba(55,50,42,.5) 50%, rgba(38,35,28,.5) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }

    /* === Focus-Visible (Accessibility) === */
    :focus-visible { outline: 2px solid rgba(217,119,6,.6); outline-offset: 2px; }
    .btn-ghost:focus-visible, .tab-btn:focus-visible, .chip:focus-visible, .lang-btn:focus-visible,
    .ai-search-btn:focus-visible, .ai-latest-btn:focus-visible, .ai-image-btn:focus-visible, .suggestion-chip:focus-visible,
    .domain-item:focus-visible, .btn-ai-analyze:focus-visible, .btn-card-export:focus-visible,
    .chat-send-btn:focus-visible {
      outline: 2px solid rgba(217,119,6,.6); outline-offset: 2px;
    }
    input:focus-visible, select:focus-visible { outline: 2px solid rgba(217,119,6,.6); outline-offset: 2px; }
    a:focus-visible { outline: 2px solid rgba(217,119,6,.6); outline-offset: 2px; border-radius: 2px; }

    /* === Reduced Motion (Accessibility) === */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; }
      .orb { animation: none !important; }
      .ai-hero-icon { animation: none !important; }
      .ai-hero-icon::after { animation: none !important; }
      .ai-hero-halo, .ai-hero-halo-outer { animation: none !important; opacity: .4 !important; }
      .heat-pulse { animation: none !important; }
      .card-stagger { opacity: 1 !important; transform: none !important; animation: none !important; }
      .kpi-stagger { opacity: 1 !important; transform: none !important; animation: none !important; }
      .skeleton, .skeleton-line { animation: none !important; }
      .streaming-cursor { animation: none !important; opacity: 1; }
      .ai-loading-dots span { animation: none !important; }
      .toast-enter { animation: none !important; }
      .toast-exit { animation: none !important; }
      .spin { animation: none !important; }
      .ai-search-box::before { animation: none !important; }
    }

    /* === WebSocket Live Dot === */
    .ws-live-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; display: inline-block; transition: background var(--duration-normal); }
    .ws-live-dot.connected { animation: wsPulse 2s ease-in-out infinite; }
    .ws-live-dot.disconnected { background: #78716c; animation: none; }
    @keyframes wsPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,.4); } 50% { box-shadow: 0 0 0 4px rgba(34,197,94,0); } }

    /* === Card Export Button === */
    .btn-card-export { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: rgba(217,119,6,.1); color: var(--text-accent); border: 1px solid rgba(217,119,6,.2); cursor: pointer; transition: all var(--duration-fast); font-weight: 600; white-space: nowrap; }
    .btn-card-export:hover { background: rgba(217,119,6,.25); border-color: rgba(217,119,6,.4); color: #fff; }
    .card .btn-card-export { opacity: .45; transition: opacity var(--duration-normal) var(--ease-out), background var(--duration-fast), border-color var(--duration-fast), color var(--duration-fast); }
    .card:hover .btn-card-export, .card .btn-card-export:focus-visible { opacity: 1; }

    /* === Chat UI === */
    #analyze-chat-area { flex-shrink: 0; padding: 12px 20px 16px; border-top: 1px solid var(--border-default); background: rgba(22,21,18,.8); backdrop-filter: blur(16px); }
    #analyze-chat-area .chat-input-row { display: flex; align-items: center; gap: 8px; }
    #analyze-chat-area input { flex: 1; padding: 10px 14px; background: rgba(38,35,28,.6); border: 1px solid var(--border-default); border-radius: var(--radius-md); color: var(--text-primary); font-size: 13px; outline: none; transition: all var(--duration-normal); }
    #analyze-chat-area input:focus { border-color: rgba(217,119,6,.4); box-shadow: 0 0 0 2px rgba(217,119,6,.08); }
    #analyze-chat-area input::placeholder { color: #57534e; }
    .chat-send-btn { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #fbbf24, #d97706, #b45309); color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--duration-normal); flex-shrink: 0; }
    .chat-send-btn:hover { box-shadow: 0 4px 16px rgba(217,119,6,.4); transform: translateY(-1px); }
    .chat-send-btn:disabled { opacity: .4; cursor: not-allowed; transform: none; box-shadow: none; }
    .chat-divider { display: flex; align-items: center; gap: 8px; margin: 20px 0 16px; }
    .chat-divider::before, .chat-divider::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, transparent, var(--border-default), transparent); }
    .chat-divider span { font-size: 10px; color: var(--text-tertiary); white-space: nowrap; }
    .chat-bubble { padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.65; margin-bottom: 10px; max-width: 88%; word-break: break-word; }
    .chat-bubble.user { background: rgba(217,119,6,.15); color: var(--text-primary); border: 1px solid rgba(217,119,6,.2); margin-left: auto; border-bottom-right-radius: 4px; }
    .chat-bubble.assistant { background: var(--bg-surface); color: var(--text-secondary); border: 1px solid var(--border-subtle); margin-right: auto; border-bottom-left-radius: 4px; }
    .chat-bubble.assistant h3 { font-size: 14px; font-weight: 700; color: var(--text-primary); margin: 12px 0 6px 0; }
    .chat-bubble.assistant h3:first-child { margin-top: 0; }
    .chat-bubble.assistant p { margin: 6px 0; }
    .chat-bubble.assistant strong { color: var(--text-primary); }
    .chat-bubble.assistant ul { margin: 6px 0; padding-left: 18px; }
    .chat-bubble.assistant li { margin: 3px 0; }

    /* === Feed Health === */
    .feed-health-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
    .feed-health-dot.healthy { background: #22c55e; }
    .feed-health-dot.stale { background: #eab308; }
    .feed-health-dot.dead { background: #ef4444; }
    .feed-health-dot.unknown { background: #78716c; }

    /* === System Health Dot === */
    .health-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .health-dot.ok { background: #22c55e; animation: wsPulse 2s ease-in-out infinite; }
    .health-dot.degraded { background: #eab308; }
    .health-dot.error { background: #ef4444; }

    /* === Reduced Motion: disable new pulse animations === */
    @media (prefers-reduced-motion: reduce) {
      .ws-live-dot.connected { animation: none !important; }
      .health-dot.ok { animation: none !important; }
    }

    /* === Responsive === */
    @media (max-width: 1023px) {
      .sidebar { display: none !important; }
      .mobile-domain-bar { display: flex !important; }
    }
    @media (min-width: 1024px) {
      .mobile-domain-bar { display: none !important; }
    }
    @media (max-width: 640px) {
      #ai-analyze-panel { width: 100vw; }
    }
  </style>
</head>
<body class="min-h-screen relative overflow-x-hidden">
  <!-- Skip Navigation -->
  <a href="#view-ai-search" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-[200] focus:px-4 focus:py-2 focus:bg-amber-600 focus:text-white focus:rounded-lg focus:text-sm focus:font-medium">Skip to content</a>

  <!-- Ambient Background Orbs -->
  <div class="orb orb-1" aria-hidden="true"></div>
  <div class="orb orb-2" aria-hidden="true"></div>
  <div class="orb orb-3" aria-hidden="true"></div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2" role="status" aria-live="polite"></div>

  <!-- Header -->
  <header class="glass sticky top-0 z-50" style="border-bottom: 1px solid transparent; background-image: linear-gradient(var(--bg-raised), var(--bg-raised)), linear-gradient(90deg, transparent, rgba(217,119,6,.10), transparent); background-origin: border-box; background-clip: padding-box, border-box;">
    <div class="max-w-[1400px] mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl flex items-center justify-center font-bold text-white text-sm shadow-lg shadow-amber-500/20" style="background:linear-gradient(135deg,#fbbf24,#d97706,#b45309)">IR</div>
        <div>
          <div class="flex items-center gap-1.5">
            <h1 class="text-base font-bold text-white tracking-tight">InsightRadar</h1>
            <span id="health-dot" class="health-dot" title="" aria-label="System health"></span>
          </div>
          <p id="subtitle" class="text-[10px] text-stone-500 font-medium tracking-wide uppercase"></p>
        </div>
        <span id="ws-live-dot" class="ws-live-dot disconnected ml-1" aria-label="WebSocket status" title=""></span>
      </div>

      <div class="hidden sm:block w-px h-6 bg-gradient-to-b from-transparent via-stone-600/30 to-transparent mx-2" aria-hidden="true"></div>

      <!-- Center: Tab Navigation -->
      <div class="tab-nav flex items-center">
        <button class="tab-btn active" data-view="ai-search" onclick="switchView('ai-search')">
          <span id="tab-ai-search-text"></span>
        </button>
        <button class="tab-btn" data-view="feed" onclick="switchView('feed')">
          <span id="tab-feed-text"></span>
        </button>
      </div>

      <div class="flex items-center gap-2">
        <!-- Refresh -->
        <button id="refresh-btn" onclick="doRefresh()" aria-label="Refresh data" class="btn-ghost flex items-center gap-1.5 px-3 py-2 text-xs font-medium">
          <svg id="refresh-icon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span id="refresh-text" class="hidden sm:inline"></span>
        </button>
        <!-- Translate -->
        <button id="translate-btn" onclick="toggleTranstone()" aria-label="Translate" class="btn-ghost flex items-center gap-1.5 px-3 py-2 text-xs font-medium">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
          </svg>
          <span id="translate-text" class="hidden sm:inline"></span>
        </button>
        <!-- Language -->
        <div class="lang-toggle flex items-center">
          <button class="lang-btn px-2.5 py-1.5 text-[11px] font-medium text-stone-400" data-lang="zh" onclick="setLang('zh')">中文</button>
          <button class="lang-btn px-2.5 py-1.5 text-[11px] font-medium text-stone-400" data-lang="en" onclick="setLang('en')">EN</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ============ AI Search View ============ -->
  <div id="view-ai-search" class="view">
    <div class="max-w-[860px] mx-auto px-4 lg:px-6 py-8 relative z-10">
      <!-- Hero -->
      <div id="ai-hero" class="text-center mb-8 fade-in">
        <div class="relative inline-block mb-5" aria-hidden="true">
          <div class="ai-hero-halo-outer"></div>
          <div class="ai-hero-halo"></div>
          <div class="ai-hero-icon relative">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z"/>
            </svg>
          </div>
        </div>
        <h2 id="ai-greeting" class="text-2xl font-bold text-white mb-2"></h2>
        <p id="ai-subtitle-text" class="text-sm text-stone-400"></p>
      </div>

      <!-- Search Input -->
      <div class="ai-search-box flex items-center gap-3 p-2 pl-5 mb-5" role="search">
        <svg class="w-5 h-5 text-stone-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input id="ai-search-input" type="text" class="ai-search-input flex-1 py-2"
               aria-label="AI search query"
               onkeydown="if(event.key==='Enter')doAISearch()">
        <input type="file" id="ai-image-input" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
        <button id="ai-image-btn" onclick="triggerImageUpload()" class="ai-image-btn" aria-label="Image Search">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          <span id="ai-image-btn-text"></span>
        </button>
        <button id="ai-latest-btn" onclick="doLatestSearch()" class="ai-latest-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          <span id="ai-latest-btn-text"></span>
        </button>
        <button id="ai-search-btn" onclick="doAISearch()" aria-label="Search" class="ai-search-btn"></button>
      </div>

      <!-- Image Preview -->
      <div id="ai-image-preview" class="ai-image-preview hidden">
        <img id="ai-image-thumb" src="" alt="preview">
        <div class="file-info">
          <div id="ai-image-name" class="file-name"></div>
          <div id="ai-image-size" class="file-size"></div>
        </div>
        <button class="remove-btn" onclick="clearImageUpload()" aria-label="Remove image">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <!-- Suggestions -->
      <div id="ai-suggestions" class="flex flex-wrap gap-2 justify-center mb-8">
        <!-- filled by JS -->
      </div>

      <!-- AI Result Area -->
      <div id="ai-result-area" class="hidden fade-in">
        <!-- Query display -->
        <div id="ai-query-display" class="flex items-center gap-2 mb-5">
          <span class="text-sm text-stone-400" id="ai-query-label"></span>
          <span id="ai-query-text" class="text-sm font-medium text-white"></span>
          <button onclick="resetAISearch()" class="ml-auto text-xs text-amber-400 hover:text-amber-300 transition-colors" id="ai-new-search-btn"></button>
        </div>

        <!-- Image Analysis Keywords -->
        <div id="ai-image-keywords" class="hidden mb-4 flex flex-wrap gap-1 items-center">
          <span class="text-xs text-stone-500 mr-1" id="ai-image-keywords-label"></span>
        </div>

        <!-- Loading -->
        <div id="ai-loading" class="hidden text-center py-12">
          <div class="ai-loading-dots mb-3"><span></span><span></span><span></span></div>
          <p id="ai-loading-text" class="text-sm text-stone-500"></p>
        </div>

        <!-- Error -->
        <div id="ai-error" class="hidden text-center py-12" role="alert">
          <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-red-900/30 flex items-center justify-center">
            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          </div>
          <p id="ai-error-text" class="text-sm text-red-300"></p>
        </div>

        <!-- API Key Setup -->
        <div id="ai-key-setup" class="hidden">
          <div class="ai-answer-panel p-6 max-w-lg mx-auto">
            <div class="flex items-center gap-2.5 mb-4">
              <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/>
                </svg>
              </div>
              <span id="ai-key-title" class="text-sm font-semibold text-white"></span>
            </div>
            <p id="ai-key-desc" class="text-xs text-stone-400 mb-4"></p>
            <div class="flex gap-2">
              <input id="ai-key-input" type="password" aria-label="API Key"
                     class="flex-1 px-4 py-2.5 bg-stone-900/50 border border-white/[.06] rounded-xl text-sm text-stone-200 placeholder-stone-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/30 transition-all"
                     onkeydown="if(event.key==='Enter')saveApiKey()">
              <button onclick="saveApiKey()" class="ai-search-btn" id="ai-key-save-btn"></button>
            </div>
            <p id="ai-key-status" class="text-xs mt-2 hidden"></p>
          </div>
        </div>

        <!-- AI Answer -->
        <div id="ai-answer-panel" class="ai-answer-panel p-6 mb-6 hidden" aria-live="polite">
          <div class="flex items-center gap-2.5 mb-4">
            <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
              </svg>
            </div>
            <span class="text-sm font-semibold text-white">InsightRadar AI</span>
          </div>
          <div id="ai-answer-content" class="text-sm leading-relaxed"></div>
        </div>

        <!-- Sources -->
        <div id="ai-sources-section" class="hidden">
          <h4 id="ai-sources-label" class="text-xs font-semibold text-stone-500 uppercase tracking-wider mb-3"></h4>
          <div id="ai-sources-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ Feed View ============ -->
  <div id="view-feed" class="view hidden">
    <div class="max-w-[1400px] mx-auto px-4 lg:px-6 py-5 flex gap-6 relative z-10">

      <!-- Sidebar (desktop) -->
      <aside class="sidebar w-56 shrink-0 sticky top-[72px] self-start hidden lg:block" style="max-height: calc(100vh - 88px); overflow-y: auto;">
        <!-- KPI Stats (Bento Grid) -->
        <div class="mb-5">
          <div class="grid grid-cols-2 gap-2">
            <div class="kpi-card px-3.5 py-3 col-span-2 kpi-stagger" style="animation-delay:0ms">
              <div class="flex items-center gap-2.5">
                <div class="kpi-icon" style="background:rgba(217,119,6,.12)">
                  <svg class="w-3.5 h-3.5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                </div>
                <div class="flex-1">
                  <div class="text-[10px] font-medium text-stone-500 uppercase tracking-wider" id="kpi-label-raw"></div>
                  <div class="kpi-value text-2xl font-bold" id="kpi-raw">-</div>
                </div>
              </div>
              <div class="kpi-accent-bar" style="background:linear-gradient(90deg,#fbbf24,#d97706,transparent)"></div>
            </div>
            <div class="kpi-card px-3.5 py-3 kpi-stagger" style="animation-delay:80ms">
              <div class="flex items-center gap-2">
                <div class="kpi-icon" style="background:rgba(74,222,128,.12)">
                  <svg class="w-3.5 h-3.5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                </div>
                <div>
                  <div class="text-[10px] font-medium text-stone-500 uppercase tracking-wider" id="kpi-label-clean"></div>
                  <div class="kpi-value text-xl font-bold" id="kpi-clean">-</div>
                </div>
              </div>
              <div class="kpi-accent-bar" style="background:linear-gradient(90deg,#4ade80,#22c55e,transparent)"></div>
            </div>
            <div class="kpi-card px-3.5 py-3 kpi-stagger" style="animation-delay:160ms">
              <div class="flex items-center gap-2">
                <div class="kpi-icon" style="background:rgba(96,165,250,.12)">
                  <svg class="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>
                </div>
                <div>
                  <div class="text-[10px] font-medium text-stone-500 uppercase tracking-wider" id="kpi-label-classified"></div>
                  <div class="kpi-value text-xl font-bold" id="kpi-classified">-</div>
                </div>
              </div>
              <div class="kpi-accent-bar" style="background:linear-gradient(90deg,#60a5fa,#3b82f6,transparent)"></div>
            </div>
          </div>
        </div>

        <div class="sidebar-separator" aria-hidden="true"></div>

        <!-- Trend Tracking -->
        <div class="mb-5" id="trend-section">
          <div class="sidebar-title mb-2" id="trend-title"></div>
          <div id="trend-list" class="flex flex-col gap-1.5 px-1">
            <!-- filled by JS -->
          </div>
        </div>

        <div class="sidebar-separator" aria-hidden="true"></div>

        <!-- Domain Navigation -->
        <div class="mb-4">
          <div class="sidebar-title mb-2" id="sidebar-domain-label"></div>
          <nav id="sidebar-domains" class="flex flex-col gap-0.5">
            <!-- filled by JS -->
          </nav>
        </div>

        <!-- Scheduler Status -->
        <div class="mt-auto pt-4 px-3" id="scheduler-section">
          <div class="sidebar-title mb-1.5" id="scheduler-label"></div>
          <div id="scheduler-status" class="text-xs text-stone-500" role="status">
            <!-- filled by JS -->
          </div>
        </div>

        <div class="sidebar-separator" aria-hidden="true"></div>

        <!-- Feed Health -->
        <div class="px-3 pb-3" id="feed-health-section">
          <div class="sidebar-title mb-2" id="feed-health-label"></div>
          <div id="feed-health-list" class="flex flex-col gap-1.5">
            <!-- filled by JS -->
          </div>
        </div>
      </aside>

      <!-- Content Area -->
      <main class="flex-1 min-w-0">
        <!-- Mobile Domain Bar -->
        <div class="mobile-domain-bar hidden overflow-x-auto gap-2 mb-4 pb-2" id="mobile-domain-filters" style="scrollbar-width: thin; scrollbar-color: #1e293b transparent;">
          <!-- filled by JS -->
        </div>

        <!-- Search + Sort Bar -->
        <div class="glass-light rounded-2xl p-3 mb-5 flex flex-col sm:flex-row gap-3">
          <div class="relative flex-1">
            <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input id="search-input" type="text" aria-label="Search items"
                   class="w-full pl-10 pr-4 py-2.5 bg-stone-900/50 border border-white/[.06] rounded-xl text-sm text-stone-200 placeholder-stone-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/30 transition-all">
          </div>
          <select id="sort-select" aria-label="Sort order"
                  class="bg-stone-900/50 border border-white/[.06] rounded-xl px-4 py-2.5 text-sm text-stone-300 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/30 appearance-none cursor-pointer min-w-[160px]">
          </select>
        </div>

        <!-- Item Count -->
        <div class="flex items-center justify-between mb-4 px-1">
          <p id="item-count" class="text-xs text-stone-500 font-medium"></p>
        </div>

        <!-- Items Grid -->
        <div id="items-grid" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
          <div class="skeleton-card"><div class="skeleton-line" style="width:60px;height:22px;margin-bottom:12px"></div><div class="skeleton-line" style="width:85%;height:14px;margin-bottom:8px"></div><div class="skeleton-line" style="width:65%;height:14px;margin-bottom:16px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:12px"></div><div class="skeleton-line" style="width:100%;height:2px;margin-bottom:12px"></div><div style="display:flex;gap:8px"><div class="skeleton-line" style="width:44px;height:18px;border-radius:6px"></div><div class="skeleton-line" style="width:30px;height:18px;border-radius:6px"></div></div></div>
          <div class="skeleton-card"><div class="skeleton-line" style="width:70px;height:22px;margin-bottom:12px"></div><div class="skeleton-line" style="width:90%;height:14px;margin-bottom:8px"></div><div class="skeleton-line" style="width:50%;height:14px;margin-bottom:16px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:12px"></div><div class="skeleton-line" style="width:100%;height:2px;margin-bottom:12px"></div><div style="display:flex;gap:8px"><div class="skeleton-line" style="width:44px;height:18px;border-radius:6px"></div><div class="skeleton-line" style="width:30px;height:18px;border-radius:6px"></div></div></div>
          <div class="skeleton-card"><div class="skeleton-line" style="width:50px;height:22px;margin-bottom:12px"></div><div class="skeleton-line" style="width:80%;height:14px;margin-bottom:8px"></div><div class="skeleton-line" style="width:70%;height:14px;margin-bottom:16px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:12px"></div><div class="skeleton-line" style="width:100%;height:2px;margin-bottom:12px"></div><div style="display:flex;gap:8px"><div class="skeleton-line" style="width:44px;height:18px;border-radius:6px"></div><div class="skeleton-line" style="width:30px;height:18px;border-radius:6px"></div></div></div>
          <div class="skeleton-card"><div class="skeleton-line" style="width:65px;height:22px;margin-bottom:12px"></div><div class="skeleton-line" style="width:75%;height:14px;margin-bottom:8px"></div><div class="skeleton-line" style="width:55%;height:14px;margin-bottom:16px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:12px"></div><div class="skeleton-line" style="width:100%;height:2px;margin-bottom:12px"></div><div style="display:flex;gap:8px"><div class="skeleton-line" style="width:44px;height:18px;border-radius:6px"></div><div class="skeleton-line" style="width:30px;height:18px;border-radius:6px"></div></div></div>
          <div class="skeleton-card"><div class="skeleton-line" style="width:55px;height:22px;margin-bottom:12px"></div><div class="skeleton-line" style="width:88%;height:14px;margin-bottom:8px"></div><div class="skeleton-line" style="width:60%;height:14px;margin-bottom:16px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:12px"></div><div class="skeleton-line" style="width:100%;height:2px;margin-bottom:12px"></div><div style="display:flex;gap:8px"><div class="skeleton-line" style="width:44px;height:18px;border-radius:6px"></div><div class="skeleton-line" style="width:30px;height:18px;border-radius:6px"></div></div></div>
          <div class="skeleton-card"><div class="skeleton-line" style="width:72px;height:22px;margin-bottom:12px"></div><div class="skeleton-line" style="width:82%;height:14px;margin-bottom:8px"></div><div class="skeleton-line" style="width:68%;height:14px;margin-bottom:16px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:12px"></div><div class="skeleton-line" style="width:100%;height:2px;margin-bottom:12px"></div><div style="display:flex;gap:8px"><div class="skeleton-line" style="width:44px;height:18px;border-radius:6px"></div><div class="skeleton-line" style="width:30px;height:18px;border-radius:6px"></div></div></div>
        </div>

        <!-- Load More -->
        <div id="load-more-container" class="hidden text-center py-8">
          <p id="shown-count" class="text-xs text-stone-500 mb-3"></p>
          <button id="load-more-btn" onclick="loadMore()" class="btn-ghost px-8 py-2.5 text-sm font-medium"></button>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-stone-800/50 to-amber-900/20 flex items-center justify-center border border-stone-700/20">
            <svg class="w-8 h-8 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <p id="empty-title" class="text-stone-400 text-base font-medium"></p>
          <p id="empty-sub" class="text-stone-600 text-sm mt-1"></p>
        </div>
      </main>
    </div>
  </div>

  <!-- AI Analyze Slide Panel Overlay -->
  <div id="ai-analyze-overlay">
    <div class="overlay-bg" onclick="closeAnalyzePanel()"></div>
    <div id="ai-analyze-panel">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-white/[.06]">
        <div class="flex items-center gap-2.5">
          <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
            </svg>
          </div>
          <span id="analyze-panel-title" class="text-sm font-semibold text-white"></span>
        </div>
        <button onclick="closeAnalyzePanel()" aria-label="Close panel" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/[.06] text-stone-400 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <!-- Article info -->
      <div id="analyze-article-info" class="px-5 py-3 border-b border-white/[.04]"></div>
      <!-- Content -->
      <div id="ai-analyze-panel-content" class="flex-1 overflow-y-auto px-5 py-4">
        <div id="analyze-loading" class="text-center py-12">
          <div class="ai-loading-dots mb-3"><span></span><span></span><span></span></div>
          <p id="analyze-loading-text" class="text-sm text-stone-500"></p>
        </div>
        <div id="analyze-result" class="hidden"></div>
        <div id="analyze-error" class="hidden text-center py-12">
          <p id="analyze-error-text" class="text-sm text-red-300"></p>
        </div>
        <div id="analyze-key-setup" class="hidden">
          <div class="ai-answer-panel p-6">
            <div class="flex items-center gap-2.5 mb-4">
              <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/>
                </svg>
              </div>
              <span id="analyze-key-title" class="text-sm font-semibold text-white"></span>
            </div>
            <p id="analyze-key-desc" class="text-xs text-stone-400 mb-4"></p>
            <div class="flex gap-2">
              <input id="analyze-key-input" type="password" aria-label="API Key"
                     class="flex-1 px-4 py-2.5 bg-stone-900/50 border border-white/[.06] rounded-xl text-sm text-stone-200 placeholder-stone-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/30 transition-all"
                     onkeydown="if(event.key==='Enter')saveApiKeyFromPanel()">
              <button onclick="saveApiKeyFromPanel()" class="ai-search-btn" id="analyze-key-save-btn"></button>
            </div>
            <p id="analyze-key-status" class="text-xs mt-2 hidden"></p>
          </div>
        </div>
        <!-- Chat messages container (appended after analysis result) -->
        <div id="chat-messages-container" class="hidden"></div>
      </div>
      <!-- Chat input area (fixed at bottom of panel) -->
      <div id="analyze-chat-area" class="hidden">
        <div class="chat-input-row">
          <input id="chat-input" type="text" aria-label="Chat message"
                 onkeydown="if(event.key==='Enter'&&!event.shiftKey)sendChatMessage()">
          <button id="chat-send-btn" class="chat-send-btn" onclick="sendChatMessage()" aria-label="Send">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5m0 0l-7 7m7-7l7 7"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== i18n ==========
    const I18N = {
      zh: {
        subtitle: '全球创新与开源情报',
        searchPlaceholder: '搜索标题、描述、标签...',
        sortHeat: '热度指数',
        sortStars: 'Stars',
        sortComments: '评论数',
        sortRecent: '最新发布',
        allDomain: '全部',
        itemCount: (n) => `共 ${n} 条情报`,
        shownCount: (shown, total) => `已加载 ${shown} / ${total}`,
        loadMore: '加载更多',
        emptyTitle: '未找到相关内容',
        emptySub: '尝试调整筛选条件或搜索关键词',
        statsRaw: '原始采集',
        statsClean: '清洗数据',
        statsClassified: '分类数据',
        refreshBtn: '刷新',
        refreshing: '采集中...',
        refreshDone: '采集完成',
        refreshError: '采集失败',
        translateBtn: '翻译',
        translateOn: '翻译中',
        translateOff: '翻译',
        expand: '展开详情',
        collapse: '收起',
        domainLabel: '领域分类',
        domainNames: {
          'AI/ML': '人工智能', 'DevTools': '开发工具', 'Hardware': '硬件',
          'Cloud': '云计算', 'Security': '安全', 'Web': 'Web 开发',
          'Mobile': '移动端', 'Data': '数据', 'Blockchain': '区块链',
          'Biotech': '生物科技', 'Other': '其他',
        },
        sourceNames: { 'github': 'GitHub', 'hackernews': 'HN', 'rss': 'RSS', 'arxiv': '论文' },
        stars: 'Stars',
        comments: '评论',
        timeAgo: { s: '秒前', m: '分钟前', h: '小时前', d: '天前' },
        // AI Search
        tabAISearch: 'AI 搜索',
        tabFeed: '信息流',
        aiGreeting: '今天想了解什么？',
        aiSubtitle: '询问今天的科技新闻和开源动态',
        aiSearchPlaceholder: '例如：AI coding 最新动态、安全漏洞、开源项目...',
        aiSearchBtn: '搜索',
        aiSearching: '正在分析相关情报...',
        aiSourcesLabel: '引用来源',
        aiQueryLabel: '搜索：',
        aiNewSearch: '新搜索',
        aiSuggestions: ['AI coding', '安全漏洞', '开源项目', 'DevTools 趋势', '云计算动态'],
        aiKeyTitle: '配置 AI 搜索',
        aiKeyDesc: '请输入通义千问 API Key 以启用 AI 搜索功能。可从 dashscope.console.aliyun.com 获取。',
        aiKeySaveBtn: '保存',
        aiKeyPlaceholder: '输入 API Key...',
        aiKeySaved: 'API Key 已保存',
        aiKeySaveError: '保存失败',
        aiAnalyzeBtn: 'AI 解读',
        aiAnalyzeTitle: 'AI 深度解读',
        aiAnalyzing: '正在分析文章...',
        aiLatestBtn: '最新热点',
        aiImageBtn: '图片搜索',
        aiImageSearching: '正在分析图片...',
        aiImageTooLarge: '图片过大，请上传 4MB 以内的图片',
        aiImageInvalid: '请上传图片文件',
        aiImageQuery: '图片搜索',
        aiImageKeywords: '识别关键词：',
        aiLatestQuery: '今日最热科技新闻与开源动态',
        trendTitle: '热度趋势',
        trendUp: '上升',
        trendDown: '下降',
        trendStable: '持平',
        trendEmpty: '暂无趋势数据',
        schedulerStatus: '调度状态',
        schedulerNext: '下次采集',
        schedulerOff: '调度未启动',
        schedulerRunning: '运行中',
        // WebSocket
        wsConnected: '实时连接',
        wsDisconnected: '已断开',
        wsNewData: '有新数据，已自动刷新',
        // Export (single article)
        exportArticle: '导出',
        exportArticleDone: '已导出',
        // Chat
        chatPlaceholder: '对这篇文章有什么疑问？',
        chatSend: '发送',
        chatThinking: '思考中...',
        // Feed Health
        feedHealth: '数据源状态',
        feedHealthy: '正常',
        feedStale: '延迟',
        feedDead: '离线',
        feedUnknown: '未知',
        // System Health
        healthOk: '系统正常',
        healthDegraded: '部分异常',
        healthError: '连接失败',
        healthDb: '数据库',
        healthSched: '调度器',
      },
      en: {
        subtitle: 'Global Innovation Intelligence',
        searchPlaceholder: 'Search titles, descriptions, tags...',
        sortHeat: 'Heat Index',
        sortStars: 'Stars',
        sortComments: 'Comments',
        sortRecent: 'Most Recent',
        allDomain: 'All',
        itemCount: (n) => `${n} items`,
        shownCount: (shown, total) => `Loaded ${shown} of ${total}`,
        loadMore: 'Load More',
        emptyTitle: 'No items found',
        emptySub: 'Try adjusting your filters or search query',
        statsRaw: 'Raw',
        statsClean: 'Cleaned',
        statsClassified: 'Classified',
        refreshBtn: 'Refresh',
        refreshing: 'Collecting...',
        refreshDone: 'Done',
        refreshError: 'Failed',
        translateBtn: 'Transtone',
        translateOn: 'Translating',
        translateOff: 'Transtone',
        expand: 'Details',
        collapse: 'Collapse',
        domainLabel: 'Domains',
        domainNames: {
          'AI/ML': 'AI / ML', 'DevTools': 'DevTools', 'Hardware': 'Hardware',
          'Cloud': 'Cloud', 'Security': 'Security', 'Web': 'Web',
          'Mobile': 'Mobile', 'Data': 'Data', 'Blockchain': 'Blockchain',
          'Biotech': 'Biotech', 'Other': 'Other',
        },
        sourceNames: { 'github': 'GitHub', 'hackernews': 'HN', 'rss': 'RSS', 'arxiv': 'Paper' },
        stars: 'Stars',
        comments: 'Comments',
        timeAgo: { s: 's ago', m: 'm ago', h: 'h ago', d: 'd ago' },
        // AI Search
        tabAISearch: 'AI Search',
        tabFeed: 'Feed',
        aiGreeting: 'What do you want to know?',
        aiSubtitle: 'Ask about today\'s tech news and open source trends',
        aiSearchPlaceholder: 'e.g., AI coding trends, security vulnerabilities, open source...',
        aiSearchBtn: 'Search',
        aiSearching: 'Analyzing relevant intelligence...',
        aiSourcesLabel: 'Sources',
        aiQueryLabel: 'Search:',
        aiNewSearch: 'New search',
        aiSuggestions: ['AI coding', 'Security', 'Open source', 'DevTools trends', 'Cloud updates'],
        aiKeyTitle: 'Configure AI Search',
        aiKeyDesc: 'Enter your Qwen API Key to enable AI search. Get one at dashscope.console.aliyun.com.',
        aiKeySaveBtn: 'Save',
        aiKeyPlaceholder: 'Enter API Key...',
        aiKeySaved: 'API Key saved',
        aiKeySaveError: 'Save failed',
        aiAnalyzeBtn: 'AI Analysis',
        aiAnalyzeTitle: 'AI Deep Analysis',
        aiAnalyzing: 'Analyzing article...',
        aiLatestBtn: 'Trending',
        aiImageBtn: 'Image Search',
        aiImageSearching: 'Analyzing image...',
        aiImageTooLarge: 'Image too large, please upload under 4MB',
        aiImageInvalid: 'Please upload an image file',
        aiImageQuery: 'Image Search',
        aiImageKeywords: 'Keywords:',
        aiLatestQuery: "Today's hottest tech news and open source trends",
        trendTitle: 'Trending',
        trendUp: 'Up',
        trendDown: 'Down',
        trendStable: 'Stable',
        trendEmpty: 'No trend data yet',
        schedulerStatus: 'Scheduler',
        schedulerNext: 'Next collect',
        schedulerOff: 'Scheduler off',
        schedulerRunning: 'Running',
        // WebSocket
        wsConnected: 'Live',
        wsDisconnected: 'Offline',
        wsNewData: 'New data — auto-refreshed',
        // Export (single article)
        exportArticle: 'Export',
        exportArticleDone: 'Exported',
        // Chat
        chatPlaceholder: 'Any questions about this article?',
        chatSend: 'Send',
        chatThinking: 'Thinking...',
        // Feed Health
        feedHealth: 'Source Health',
        feedHealthy: 'Healthy',
        feedStale: 'Stale',
        feedDead: 'Dead',
        feedUnknown: 'Unknown',
        // System Health
        healthOk: 'System OK',
        healthDegraded: 'Degraded',
        healthError: 'Connection failed',
        healthDb: 'Database',
        healthSched: 'Scheduler',
      },
    };

    let lang = localStorage.getItem('ir-lang') || 'zh';
    let currentView = 'ai-search';
    function t() { return I18N[lang]; }

    // ========== View Switching ==========
    function switchView(view) {
      currentView = view;
      document.getElementById('view-ai-search').classList.toggle('hidden', view !== 'ai-search');
      document.getElementById('view-feed').classList.toggle('hidden', view !== 'feed');

      // Tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });

      // Feed-only buttons
      document.querySelectorAll('.feed-only-btn').forEach(btn => {
        btn.classList.toggle('hidden', view !== 'feed');
      });

      // Load feed data on first switch
      if (view === 'feed' && !feedLoaded) {
        feedLoaded = true;
        loadDomains();
        loadItems(false);
        loadStats();
        loadTrends();
      }
    }

    let feedLoaded = false;

    function setLang(l) {
      lang = l;
      localStorage.setItem('ir-lang', l);
      document.documentElement.lang = l === 'zh' ? 'zh-CN' : 'en';
      applyLang();
      loadSchedulerStatus();
      if (feedLoaded) {
        loadDomains();
        resetAndLoadItems();
        loadStats();
        loadTrends();
      }
    }

    function applyLang() {
      const s = t();
      document.getElementById('subtitle').textContent = s.subtitle;
      document.getElementById('search-input').placeholder = s.searchPlaceholder;
      document.getElementById('empty-title').textContent = s.emptyTitle;
      document.getElementById('empty-sub').textContent = s.emptySub;
      document.getElementById('refresh-text').textContent = s.refreshBtn;
      document.getElementById('translate-text').textContent = translateMode ? s.translateOn : s.translateBtn;
      document.getElementById('load-more-btn').textContent = s.loadMore;
      document.getElementById('sidebar-domain-label').textContent = s.domainLabel;

      // KPI labels
      document.getElementById('kpi-label-raw').textContent = s.statsRaw;
      document.getElementById('kpi-label-clean').textContent = s.statsClean;
      document.getElementById('kpi-label-classified').textContent = s.statsClassified;

      const sel = document.getElementById('sort-select');
      const curVal = sel.value || 'heat';
      sel.innerHTML = `
        <option value="heat">${s.sortHeat}</option>
        <option value="stars">${s.sortStars}</option>
        <option value="comments">${s.sortComments}</option>
        <option value="recent">${s.sortRecent}</option>
      `;
      sel.value = curVal;

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Tab labels
      document.getElementById('tab-ai-search-text').textContent = s.tabAISearch;
      document.getElementById('tab-feed-text').textContent = s.tabFeed;

      // AI Search labels
      document.getElementById('ai-greeting').textContent = s.aiGreeting;
      document.getElementById('ai-subtitle-text').textContent = s.aiSubtitle;
      document.getElementById('ai-search-input').placeholder = s.aiSearchPlaceholder;
      document.getElementById('ai-search-btn').textContent = s.aiSearchBtn;
      document.getElementById('ai-loading-text').textContent = s.aiSearching;
      document.getElementById('ai-sources-label').textContent = s.aiSourcesLabel;
      document.getElementById('ai-query-label').textContent = s.aiQueryLabel;
      document.getElementById('ai-new-search-btn').textContent = s.aiNewSearch;

      // API Key setup labels
      document.getElementById('ai-key-title').textContent = s.aiKeyTitle;
      document.getElementById('ai-key-desc').textContent = s.aiKeyDesc;
      document.getElementById('ai-key-save-btn').textContent = s.aiKeySaveBtn;
      document.getElementById('ai-key-input').placeholder = s.aiKeyPlaceholder;

      // AI Analyze panel labels
      document.getElementById('analyze-panel-title').textContent = s.aiAnalyzeTitle;
      document.getElementById('analyze-loading-text').textContent = s.aiAnalyzing;
      document.getElementById('analyze-key-title').textContent = s.aiKeyTitle;
      document.getElementById('analyze-key-desc').textContent = s.aiKeyDesc;
      document.getElementById('analyze-key-save-btn').textContent = s.aiKeySaveBtn;
      document.getElementById('analyze-key-input').placeholder = s.aiKeyPlaceholder;

      // Lightning button
      document.getElementById('ai-latest-btn-text').textContent = s.aiLatestBtn;

      // Image search button
      document.getElementById('ai-image-btn-text').textContent = s.aiImageBtn;
      document.getElementById('ai-image-btn').setAttribute('aria-label', s.aiImageBtn);

      // Aria labels (i18n-aware)
      document.getElementById('refresh-btn').setAttribute('aria-label', lang === 'zh' ? '刷新数据' : 'Refresh data');
      document.getElementById('translate-btn').setAttribute('aria-label', lang === 'zh' ? '翻译' : 'Translate');
      document.getElementById('ai-search-input').setAttribute('aria-label', lang === 'zh' ? 'AI 搜索' : 'AI search query');
      document.getElementById('search-input').setAttribute('aria-label', lang === 'zh' ? '搜索条目' : 'Search items');
      document.getElementById('sort-select').setAttribute('aria-label', lang === 'zh' ? '排序方式' : 'Sort order');

      // Chat input placeholder
      const chatInput = document.getElementById('chat-input');
      if (chatInput) chatInput.placeholder = s.chatPlaceholder;

      // WS dot tooltip
      const wsDot = document.getElementById('ws-live-dot');
      wsDot.title = wsDot.classList.contains('connected') ? s.wsConnected : s.wsDisconnected;

      // Feed health label
      const feedHealthLabel = document.getElementById('feed-health-label');
      if (feedHealthLabel) feedHealthLabel.textContent = s.feedHealth;

      // Render suggestions
      const sugContainer = document.getElementById('ai-suggestions');
      sugContainer.innerHTML = s.aiSuggestions.map(sug =>
        `<button class="suggestion-chip" onclick="doAISearch('${sug}')">${sug}</button>`
      ).join('');
    }

    // ========== Config ==========
    const DOMAIN_ICONS = {
      'AI/ML': '&#x1F916;', 'DevTools': '&#x1F6E0;', 'Hardware': '&#x1F4BB;',
      'Cloud': '&#x2601;', 'Security': '&#x1F512;', 'Web': '&#x1F310;',
      'Mobile': '&#x1F4F1;', 'Data': '&#x1F4CA;', 'Blockchain': '&#x26D3;',
      'Biotech': '&#x1F9EC;', 'Other': '&#x1F4E6;',
    };

    const DOMAIN_COLORS = {
      'AI/ML': { bg: 'rgba(217,119,6,.12)', text: '#fbbf24', border: 'rgba(217,119,6,.3)', accent: '#d97706' },
      'DevTools': { bg: 'rgba(45,212,191,.1)', text: '#5eead4', border: 'rgba(45,212,191,.25)', accent: '#2dd4bf' },
      'Hardware': { bg: 'rgba(239,68,68,.1)', text: '#fca5a5', border: 'rgba(239,68,68,.2)', accent: '#ef4444' },
      'Cloud': { bg: 'rgba(96,165,250,.1)', text: '#93c5fd', border: 'rgba(96,165,250,.25)', accent: '#60a5fa' },
      'Security': { bg: 'rgba(250,204,21,.1)', text: '#fde047', border: 'rgba(250,204,21,.2)', accent: '#facc15' },
      'Web': { bg: 'rgba(168,162,150,.1)', text: '#d6d3d1', border: 'rgba(168,162,150,.2)', accent: '#a8a29e' },
      'Mobile': { bg: 'rgba(251,146,60,.1)', text: '#fdba74', border: 'rgba(251,146,60,.25)', accent: '#fb923c' },
      'Data': { bg: 'rgba(74,222,128,.1)', text: '#86efac', border: 'rgba(74,222,128,.25)', accent: '#4ade80' },
      'Blockchain': { bg: 'rgba(180,83,9,.12)', text: '#f59e0b', border: 'rgba(180,83,9,.25)', accent: '#b45309' },
      'Biotech': { bg: 'rgba(232,121,249,.1)', text: '#f0abfc', border: 'rgba(232,121,249,.25)', accent: '#e879f9' },
      'Other': { bg: 'rgba(168,162,150,.08)', text: '#a8a29e', border: 'rgba(168,162,150,.15)', accent: '#a8a29e' },
    };

    const SOURCE_STYLES = {
      'github': { bg: 'rgba(110,118,129,.15)', text: '#c9d1d9', label: 'GitHub' },
      'hackernews': { bg: 'rgba(255,102,0,.12)', text: '#ff8c40', label: 'HN' },
      'rss': { bg: 'rgba(74,222,128,.1)', text: '#86efac', label: 'RSS' },
      'arxiv': { bg: 'rgba(168,85,247,.12)', text: '#c084fc', label: '论文' },
      'web_search': { bg: 'rgba(59,130,246,.12)', text: '#60a5fa', label: 'Web' },
    };

    let currentDomain = 'All';
    let currentSearch = '';
    let currentSort = 'heat';
    let debounceTimer = null;
    let PAGE_SIZE = 20;
    let currentOffset = 0;
    let totalItems = 0;
    let translateMode = false;
    const translationCache = {};
    let aiSearchAbort = null;
    let analyzeAbort = null;
    const itemDataCache = {};
    const CACHE_MAX = 200;
    // Image search state
    let pendingImageBase64 = null;
    let pendingImageFile = null;
    // Chat state
    let chatMessages = [];
    let chatAbort = null;
    let currentAnalysisText = '';
    let currentAnalysisItem = null;

    // ========== Toast ==========
    function showToast(msg, type = 'info') {
      const container = document.getElementById('toast-container');
      const colors = {
        info: 'glass text-stone-300',
        success: 'bg-emerald-900/80 border border-emerald-700/50 text-emerald-200',
        error: 'bg-red-900/80 border border-red-700/50 text-red-200',
      };
      const el = document.createElement('div');
      el.className = `toast-enter px-4 py-3 rounded-xl text-sm font-medium ${colors[type] || colors.info}`;
      el.textContent = msg;
      container.appendChild(el);
      setTimeout(() => {
        el.classList.remove('toast-enter');
        el.classList.add('toast-exit');
        setTimeout(() => el.remove(), 300);
      }, 4000);
    }

    // ========== Cache LRU ==========
    function cacheItem(key, item) {
      const keys = Object.keys(itemDataCache);
      if (keys.length >= CACHE_MAX) {
        delete itemDataCache[keys[0]];
      }
      itemDataCache[key] = item;
    }

    // ========== Image Search ==========
    function triggerImageUpload() {
      document.getElementById('ai-image-input').click();
    }

    // Shared handler for file select, paste, and drag-drop
    async function processImageFile(file) {
      if (!file || !file.type.startsWith('image/')) {
        showToast(t().aiImageInvalid, 'error');
        return;
      }
      if (file.size > 4 * 1024 * 1024) {
        showToast(t().aiImageTooLarge, 'error');
        return;
      }

      pendingImageFile = file;
      pendingImageBase64 = file.size > 2 * 1024 * 1024
        ? await compressImage(file) : await fileToBase64(file);

      // Show preview
      const preview = document.getElementById('ai-image-preview');
      document.getElementById('ai-image-thumb').src = URL.createObjectURL(file);
      document.getElementById('ai-image-name').textContent = file.name || 'pasted-image.png';
      document.getElementById('ai-image-size').textContent = formatFileSize(file.size);
      preview.classList.remove('hidden');
      document.getElementById('ai-image-btn').classList.add('has-image');

      doImageSearch();
    }

    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      await processImageFile(file);
      event.target.value = '';
    }

    function clearImageUpload() {
      pendingImageBase64 = null;
      pendingImageFile = null;
      document.getElementById('ai-image-preview').classList.add('hidden');
      document.getElementById('ai-image-input').value = '';
      document.getElementById('ai-image-btn').classList.remove('has-image');
      document.getElementById('ai-image-keywords').classList.add('hidden');
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function compressImage(file, maxDim = 1200, quality = 0.8) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if (w > maxDim || h > maxDim) {
            const ratio = Math.min(maxDim / w, maxDim / h);
            w = Math.round(w * ratio);
            h = Math.round(h * ratio);
          }
          canvas.width = w;
          canvas.height = h;
          canvas.getContext('2d').drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL('image/jpeg', quality));
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function doImageSearch() {
      if (!pendingImageBase64) return;

      // Abort previous
      if (aiSearchAbort) { aiSearchAbort.abort(); aiSearchAbort = null; }

      const queryLabel = t().aiImageQuery;
      document.getElementById('ai-search-input').value = queryLabel;
      document.getElementById('ai-hero').classList.add('hidden');
      document.getElementById('ai-suggestions').classList.add('hidden');
      document.getElementById('ai-result-area').classList.remove('hidden');
      document.getElementById('ai-query-text').textContent = queryLabel;
      document.getElementById('ai-loading').classList.remove('hidden');
      document.getElementById('ai-loading-text').textContent = t().aiImageSearching;
      document.getElementById('ai-error').classList.add('hidden');
      document.getElementById('ai-key-setup').classList.add('hidden');
      document.getElementById('ai-answer-panel').classList.add('hidden');
      document.getElementById('ai-sources-section').classList.add('hidden');
      document.getElementById('ai-answer-content').innerHTML = '';
      document.getElementById('ai-image-keywords').classList.add('hidden');
      document.getElementById('ai-search-btn').disabled = true;
      document.getElementById('ai-latest-btn').disabled = true;
      document.getElementById('ai-image-btn').disabled = true;
      aiSources = [];

      const controller = new AbortController();
      aiSearchAbort = controller;
      let fullText = '';

      try {
        const resp = await fetch('/api/ai-image-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: pendingImageBase64 }),
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: (sources) => {
            aiSources = sources;
            renderAISources(aiSources);
          },
          onWebSources: (webSources) => {
            _mergeWebSources(webSources);
            renderAISources(aiSources);
          },
          onImageAnalysis: (data) => {
            // Display extracted keywords as tags
            if (data && data.keywords && data.keywords.length > 0) {
              const container = document.getElementById('ai-image-keywords');
              container.innerHTML = `<span class="text-xs text-stone-500 mr-1">${t().aiImageKeywords}</span>` +
                data.keywords.map(k => `<span class="ai-keyword-tag">${k}</span>`).join('');
              container.classList.remove('hidden');
            }
          },
          onChunk: (text) => {
            fullText += text;
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-answer-panel').classList.remove('hidden');
            renderStreamingMarkdown(fullText);
          },
          onDone: () => {},
          onError: (msg) => {
            showAIError(msg);
          },
        });

        if (fullText) {
          renderFinalMarkdown(fullText);
          filterCitedSources(fullText);
        }

      } catch (e) {
        if (e.name !== 'AbortError') {
          showAIError(e.message);
        }
      } finally {
        document.getElementById('ai-search-btn').disabled = false;
        document.getElementById('ai-latest-btn').disabled = false;
        document.getElementById('ai-image-btn').disabled = false;
        document.getElementById('ai-loading').classList.add('hidden');
        aiSearchAbort = null;
      }
    }

    // ========== Time ==========
    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const diff = Math.floor((new Date() - new Date(dateStr)) / 1000);
      const u = t().timeAgo;
      if (diff < 60) return diff + u.s;
      if (diff < 3600) return Math.floor(diff / 60) + u.m;
      if (diff < 86400) return Math.floor(diff / 3600) + u.h;
      return Math.floor(diff / 86400) + u.d;
    }

    // ========== Heat ==========
    function getHeatColor(heat) {
      if (heat >= 70) return '#ef4444';
      if (heat >= 50) return '#d97706';
      if (heat >= 30) return '#b08d57';
      return '#78716c';
    }

    function getHeatGradient(heat) {
      if (heat >= 70) return 'linear-gradient(90deg, #ef4444, #f97316)';
      if (heat >= 50) return 'linear-gradient(90deg, #d97706, #fbbf24)';
      if (heat >= 30) return 'linear-gradient(90deg, #b08d57, #c9a04e)';
      return 'linear-gradient(90deg, #78716c, #a8a29e)';
    }

    function domainLabel(key) { return t().domainNames[key] || key; }
    function sourceLabel(key) { return t().sourceNames[key] || key; }

    // ========== Card Render ==========
    function renderCard(item) {
      const cacheKey = 'item-' + item.id;
      cacheItem(cacheKey, item);

      const dc = DOMAIN_COLORS[item.domain] || DOMAIN_COLORS['Other'];
      const heatColor = getHeatColor(item.heat_index);
      const heatGrad = getHeatGradient(item.heat_index);
      const isHot = item.heat_index >= 70;

      const badges = item.sources.map(s => {
        const st = SOURCE_STYLES[s] || SOURCE_STYLES['rss'];
        return `<span class="source-badge" style="background:${st.bg};color:${st.text}">${sourceLabel(s)}</span>`;
      }).join('');

      const tags = (item.tags || []).slice(0, 5).map(tag =>
        `<span class="tag-pill">${tag}</span>`
      ).join('');

      const desc = item.description
        ? (item.description.length > 160 ? item.description.substring(0, 160) + '...' : item.description)
        : '';

      const ago = timeAgo(item.published_at);
      const detailId = 'detail-' + item.id;
      const hasDetails = tags || item.heat_reason;

      return `
        <div class="card p-5 card-stagger ${isHot ? 'card-hot' : ''}">
          ${isHot ? '<div class="card-hot-glow"></div>' : ''}
          <!-- Top row: domain + heat -->
          <div class="flex items-center justify-between mb-3">
            <span class="text-[11px] font-semibold px-2.5 py-1 rounded-lg" style="background:${dc.bg};color:${dc.text};border:1px solid ${dc.border}">${domainLabel(item.domain)}</span>
            <div class="flex items-center gap-1.5">
              <div class="w-2 h-2 rounded-full ${isHot ? 'heat-pulse' : ''}" style="background:${heatColor};color:${heatColor}"></div>
              <span class="text-sm font-bold text-mono" style="color:${heatColor}">${item.heat_index}</span>
            </div>
          </div>

          <!-- Title -->
          <a href="${item.url}" target="_blank" rel="noopener"
             class="card-title block text-[13px] font-semibold text-stone-100 mb-2 leading-snug hover:text-amber-400 transition-colors line-clamp-2"
             data-original="${item.title.replace(/"/g, '&quot;')}">${item.title}</a>

          <!-- Description -->
          ${desc ? `<p class="card-desc text-xs text-stone-400 mb-3 leading-relaxed line-clamp-3" data-original="${desc.replace(/"/g, '&quot;')}">${desc}</p>` : '<div class="mb-3"></div>'}

          <!-- Heat bar -->
          <div class="heat-bar-bg w-full mb-3">
            <div class="heat-bar-fill" style="width:${Math.min(item.heat_index, 100)}%;background:${heatGrad}"></div>
          </div>

          <!-- Footer -->
          <div class="flex items-center justify-between text-[11px]">
            <div class="flex items-center gap-2">
              ${badges}
              ${ago ? `<span class="text-stone-500">${ago}</span>` : ''}
              <button class="btn-card-export" onclick="event.stopPropagation();exportSingleArticle(itemDataCache['${cacheKey}'],this)">
                <svg class="w-3 h-3 inline -mt-px mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                ${t().exportArticle}
              </button>
              <button class="btn-ai-analyze" onclick="event.stopPropagation();openAnalyzePanel(itemDataCache['${cacheKey}'])">
                <svg class="w-3 h-3 inline -mt-px mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
                ${t().aiAnalyzeBtn}
              </button>
            </div>
            <div class="flex items-center gap-3 text-stone-500">
              ${item.stars > 0 ? `<span class="flex items-center gap-1" title="${t().stars}"><svg class="w-3 h-3 text-yellow-500/70" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>${item.stars.toLocaleString()}</span>` : ''}
              ${item.comments_count > 0 ? `<span class="flex items-center gap-1" title="${t().comments}"><svg class="w-3 h-3 text-blue-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>${item.comments_count}</span>` : ''}
              ${item.language ? `<span>${item.language}</span>` : ''}
            </div>
          </div>

          <!-- Expandable details -->
          ${hasDetails ? `
          <div class="mt-3 pt-3 border-t border-white/[.04]">
            <button class="details-toggle text-[11px] text-amber-400/80 hover:text-amber-300 font-medium transition-colors" onclick="toggleDetails('${detailId}', this)">${t().expand}</button>
            <div id="${detailId}" class="details-content mt-2">
              ${tags ? `<div class="flex flex-wrap gap-1.5 mb-2">${tags}</div>` : ''}
              ${item.heat_reason ? `<p class="text-[11px] text-stone-500 italic leading-relaxed">${item.heat_reason}</p>` : ''}
            </div>
          </div>` : ''}
        </div>
      `;
    }

    function toggleDetails(id, btn) {
      const el = document.getElementById(id);
      const isOpen = el.classList.toggle('open');
      btn.textContent = isOpen ? t().collapse : t().expand;
    }

    // ========== Refresh ==========
    async function doRefresh() {
      const btn = document.getElementById('refresh-btn');
      const icon = document.getElementById('refresh-icon');
      const text = document.getElementById('refresh-text');
      btn.disabled = true;
      btn.style.opacity = '.5';
      icon.classList.add('spin');
      text.textContent = t().refreshing;

      try {
        const resp = await fetch('/api/collect', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
          showToast(`${t().refreshDone}: ${data.stats?.new || 0} new`, 'success');
          resetAndLoadItems();
          loadDomains();
          loadStats();
        } else if (data.status === 'busy') {
          showToast(data.message, 'info');
        } else {
          showToast(`${t().refreshError}: ${data.message}`, 'error');
        }
      } catch (e) {
        showToast(`${t().refreshError}: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
        icon.classList.remove('spin');
        text.textContent = t().refreshBtn;
      }
    }

    // ========== Translation ==========
    async function translateText(text) {
      if (!text || text.trim() === '') return text;
      const key = text.substring(0, 100);
      if (translationCache[key]) return translationCache[key];
      try {
        const resp = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text, target: 'zh' }),
        });
        const data = await resp.json();
        if (data.translated) {
          translationCache[key] = data.translated;
          return data.translated;
        }
      } catch (e) {}
      return text;
    }

    async function translateVisibleCards() {
      for (const el of document.querySelectorAll('.card-title')) {
        const original = el.dataset.original || el.textContent;
        el.dataset.original = original;
        el.textContent = await translateText(original);
      }
      for (const el of document.querySelectorAll('.card-desc')) {
        const original = el.dataset.original || el.textContent;
        el.dataset.original = original;
        el.textContent = await translateText(original);
      }
    }

    function restoreOriginalText() {
      document.querySelectorAll('.card-title').forEach(el => {
        if (el.dataset.original) el.textContent = el.dataset.original;
      });
      document.querySelectorAll('.card-desc').forEach(el => {
        if (el.dataset.original) el.textContent = el.dataset.original;
      });
    }

    async function toggleTranstone() {
      translateMode = !translateMode;
      const btn = document.getElementById('translate-btn');
      const text = document.getElementById('translate-text');
      if (translateMode) {
        btn.classList.add('active');
        text.textContent = t().translateOn;
        await translateVisibleCards();
      } else {
        btn.classList.remove('active');
        text.textContent = t().translateBtn;
        restoreOriginalText();
      }
    }

    // ========== AI Search ==========
    let aiSources = [];

    function resetAISearch() {
      document.getElementById('ai-hero').classList.remove('hidden');
      document.getElementById('ai-suggestions').classList.remove('hidden');
      document.getElementById('ai-result-area').classList.add('hidden');
      document.getElementById('ai-loading').classList.add('hidden');
      document.getElementById('ai-error').classList.add('hidden');
      document.getElementById('ai-key-setup').classList.add('hidden');
      document.getElementById('ai-answer-panel').classList.add('hidden');
      document.getElementById('ai-sources-section').classList.add('hidden');
      document.getElementById('ai-search-input').value = '';
      document.getElementById('ai-search-btn').disabled = false;
      document.getElementById('ai-latest-btn').disabled = false;
      document.getElementById('ai-image-btn').disabled = false;
      document.getElementById('ai-answer-content').innerHTML = '';
      document.getElementById('ai-image-keywords').classList.add('hidden');
      clearImageUpload();
      aiSources = [];
      if (aiSearchAbort) { aiSearchAbort.abort(); aiSearchAbort = null; }
    }

    async function doAISearch(query) {
      if (!query) query = document.getElementById('ai-search-input').value.trim();
      // If there's an uploaded image, do image search instead
      if (pendingImageBase64) {
        return doImageSearch();
      }
      if (!query) return;

      // Abort previous
      if (aiSearchAbort) { aiSearchAbort.abort(); aiSearchAbort = null; }

      document.getElementById('ai-search-input').value = query;
      document.getElementById('ai-hero').classList.add('hidden');
      document.getElementById('ai-suggestions').classList.add('hidden');
      document.getElementById('ai-result-area').classList.remove('hidden');
      document.getElementById('ai-query-text').textContent = query;
      document.getElementById('ai-loading').classList.remove('hidden');
      document.getElementById('ai-error').classList.add('hidden');
      document.getElementById('ai-key-setup').classList.add('hidden');
      document.getElementById('ai-answer-panel').classList.add('hidden');
      document.getElementById('ai-sources-section').classList.add('hidden');
      document.getElementById('ai-answer-content').innerHTML = '';
      document.getElementById('ai-search-btn').disabled = true;
      document.getElementById('ai-latest-btn').disabled = true;
      document.getElementById('ai-image-btn').disabled = true;
      aiSources = [];

      const controller = new AbortController();
      aiSearchAbort = controller;
      let fullText = '';

      try {
        const resp = await fetch('/api/ai-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: (sources) => {
            aiSources = sources;
            renderAISources(aiSources);
          },
          onWebSources: (webSources) => {
            _mergeWebSources(webSources);
            renderAISources(aiSources);
          },
          onChunk: (text) => {
            fullText += text;
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-answer-panel').classList.remove('hidden');
            renderStreamingMarkdown(fullText);
          },
          onDone: () => {},
          onError: (msg) => {
            showAIError(msg);
          },
        });

        if (fullText) {
          renderFinalMarkdown(fullText);
          filterCitedSources(fullText);
        }

      } catch (e) {
        if (e.name !== 'AbortError') {
          showAIError(e.message);
        }
      } finally {
        document.getElementById('ai-search-btn').disabled = false;
        document.getElementById('ai-latest-btn').disabled = false;
        document.getElementById('ai-image-btn').disabled = false;
        document.getElementById('ai-loading').classList.add('hidden');
        aiSearchAbort = null;
      }
    }

    function showAIError(msg) {
      document.getElementById('ai-loading').classList.add('hidden');
      if (msg === 'needsApiKey') {
        // Show API key setup panel instead of generic error
        document.getElementById('ai-error').classList.add('hidden');
        document.getElementById('ai-key-setup').classList.remove('hidden');
        return;
      }
      document.getElementById('ai-key-setup').classList.add('hidden');
      document.getElementById('ai-error').classList.remove('hidden');
      document.getElementById('ai-error-text').textContent = msg;
    }

    async function saveApiKey() {
      const input = document.getElementById('ai-key-input');
      const status = document.getElementById('ai-key-status');
      const key = input.value.trim();
      if (!key) return;

      try {
        const resp = await fetch('/api/ai-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key }),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          status.textContent = t().aiKeySaved;
          status.className = 'text-xs mt-2 text-emerald-400';
          status.classList.remove('hidden');
          // Re-run the previous search after a short delay
          setTimeout(() => {
            document.getElementById('ai-key-setup').classList.add('hidden');
            status.classList.add('hidden');
            const query = document.getElementById('ai-search-input').value.trim();
            if (query) doAISearch(query);
          }, 800);
        } else {
          status.textContent = data.message || t().aiKeySaveError;
          status.className = 'text-xs mt-2 text-red-400';
          status.classList.remove('hidden');
        }
      } catch (e) {
        status.textContent = t().aiKeySaveError + ': ' + e.message;
        status.className = 'text-xs mt-2 text-red-400';
        status.classList.remove('hidden');
      }
    }

    function _mergeWebSources(webSources) {
      // Append web sources after local sources as supplementary results.
      // GLM's refer field is just a sequential ID, not a citation number mapping.
      webSources.forEach(ws => {
        ws._isWebSource = true;
        aiSources.push(ws);
      });
    }

    function filterCitedSources(fullText) {
      // Extract all [N] citation numbers from the AI response
      const citedNums = new Set();
      let m;
      const pat = /\[(\d+)\]/g;
      while ((m = pat.exec(fullText)) !== null) citedNums.add(parseInt(m[1], 10));

      const localSources = aiSources.filter(s => !s._isWebSource);
      const webSources = aiSources.filter(s => s._isWebSource);

      if (citedNums.size === 0) {
        aiSources = webSources;
        renderAISources(aiSources);
        return;
      }

      // Direct index: [N] → localSources[N-1] (guaranteed by backend build_ai_prompt)
      const citedInOrder = [...citedNums].sort((a, b) => a - b);
      const newLocal = [];
      const remapTable = {};
      for (const n of citedInOrder) {
        const src = localSources[n - 1];
        if (src) {
          newLocal.push(src);
          remapTable[n] = newLocal.length; // new 1-based index
        }
      }

      aiSources = [...newLocal, ...webSources];
      renderAISources(aiSources);

      // Update citation badge numbers in rendered HTML
      const content = document.getElementById('ai-answer-content');
      content.querySelectorAll('.citation').forEach(el => {
        const oldNum = parseInt(el.textContent, 10);
        const newNum = remapTable[oldNum];
        if (newNum !== undefined) {
          el.textContent = newNum;
          el.setAttribute('onclick', `scrollToSource(${newNum})`);
          const src = aiSources[newNum - 1];
          if (src) el.setAttribute('title', src.title.replace(/"/g, '&quot;').substring(0, 60));
        } else {
          el.remove(); // N exceeds local sources range
        }
      });
    }

    function renderAISources(sources) {
      const grid = document.getElementById('ai-sources-grid');
      const section = document.getElementById('ai-sources-section');
      if (!sources.length) {
        section.classList.add('hidden');
        grid.innerHTML = '';
        return;
      }
      section.classList.remove('hidden');

      const firstWebIdx = sources.findIndex(s => s._isWebSource || (s.sources && s.sources.includes('web_search')));

      grid.innerHTML = sources.map((item, i) => {
        const cacheKey = 'aisrc-' + i;
        cacheItem(cacheKey, item);
        const isWeb = item._isWebSource || (item.sources && item.sources.includes('web_search'));
        const dc = DOMAIN_COLORS[item.domain] || DOMAIN_COLORS['Other'];
        const heatColor = getHeatColor(item.heat_index);
        const srcBadges = (item.sources || []).map(s => {
          const st = SOURCE_STYLES[s] || SOURCE_STYLES['rss'];
          return `<span class="source-badge" style="background:${st.bg};color:${st.text}">${st.label}</span>`;
        }).join('');

        const clickAction = item.url ? `onclick="window.open('${item.url}','_blank')"` : '';
        const globeSvg = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline;vertical-align:-1px"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>';
        const divider = (i === firstWebIdx && firstWebIdx > 0) ? `<div style="grid-column:1/-1;display:flex;align-items:center;gap:8px;padding:4px 0"><div style="flex:1;height:1px;background:rgba(59,130,246,.25)"></div><span style="font-size:10px;color:#60a5fa;white-space:nowrap;display:inline-flex;align-items:center;gap:4px">${globeSvg} ${lang === 'zh' ? '联网补充' : 'Web Results'}</span><div style="flex:1;height:1px;background:rgba(59,130,246,.25)"></div></div>` : '';
        return divider + `
          <div class="ai-source-card${isWeb ? ' web-source' : ''}" id="ai-source-${i + 1}" ${clickAction} style="${item.url ? 'cursor:pointer' : 'cursor:default'}">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs font-bold text-amber-400 bg-amber-500/10 px-1.5 py-0.5 rounded">[${i + 1}]</span>
              <span class="text-[10px] font-semibold px-2 py-0.5 rounded" style="background:${dc.bg};color:${dc.text}">${item.domain}</span>
              <span class="text-xs font-bold ml-auto" style="color:${heatColor}">${item.heat_index}</span>
            </div>
            <p class="card-title text-xs font-semibold text-stone-200 leading-snug mb-1.5 line-clamp-2" data-original="${item.title.replace(/"/g, '&quot;')}">${item.title}</p>
            <div class="flex items-center justify-between text-[10px]">
              <div class="flex items-center gap-2">
                ${srcBadges}
                ${item.stars > 0 ? `<span class="text-stone-500">${item.stars} stars</span>` : ''}
                ${item.comments_count > 0 ? `<span class="text-stone-500">${item.comments_count} comments</span>` : ''}
              </div>
              <div class="flex items-center gap-1.5">
                <button class="btn-card-export" onclick="event.stopPropagation();exportSingleArticle(itemDataCache['${cacheKey}'],this)" style="font-size:9px;padding:1px 6px">
                  <svg class="w-2.5 h-2.5 inline -mt-px mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  ${t().exportArticle}
                </button>
                <button class="btn-ai-analyze" onclick="event.stopPropagation();openAnalyzePanel(itemDataCache['${cacheKey}'])">
                  <svg class="w-3 h-3 inline -mt-px mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
                  ${t().aiAnalyzeBtn}
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      if (translateMode) translateVisibleCards();
    }

    // ========== Markdown Rendering ==========
    function renderMarkdown(text) {
      let html = text
        // Escape HTML
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        // Headers
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        // Bold
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // Links [text](url)
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
        // Citations [N] — with tooltip showing source title
        .replace(/\[(\d+)\]/g, (match, num) => {
          const idx = parseInt(num, 10) - 1;
          const src = (typeof aiSources !== 'undefined' && aiSources[idx]) ? aiSources[idx] : null;
          const tip = src ? src.title.replace(/"/g, '&quot;').substring(0, 60) : '';
          return `<span class="citation" onclick="scrollToSource(${num})" title="${tip}">${num}</span>`;
        })
        // List items
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        // Wrap consecutive <li> in <ul>
        .replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>')
        // Paragraphs (double newline)
        .replace(/\n\n/g, '</p><p>')
        // Single newlines within paragraphs
        .replace(/\n/g, '<br>');

      // Wrap in <p> if not starting with block element
      if (!html.startsWith('<h3>') && !html.startsWith('<ul>')) {
        html = '<p>' + html + '</p>';
      }

      // Clean up empty <p> tags
      html = html.replace(/<p><\/p>/g, '').replace(/<p>(<h3>)/g, '$1').replace(/(<\/h3>)<\/p>/g, '$1');

      return html;
    }

    function renderStreamingMarkdown(text) {
      const content = document.getElementById('ai-answer-content');
      content.innerHTML = renderMarkdown(text) + '<span class="streaming-cursor"></span>';
      content.scrollTop = content.scrollHeight;
    }

    function renderFinalMarkdown(text) {
      const content = document.getElementById('ai-answer-content');
      content.innerHTML = renderMarkdown(text);
    }

    function scrollToSource(n) {
      const card = document.getElementById(`ai-source-${n}`);
      if (!card) return;
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card.classList.add('highlight');
      setTimeout(() => card.classList.remove('highlight'), 2000);
    }

    // ========== Shared SSE Processing ==========
    async function _processSSE(response, { onSources, onChunk, onDone, onError, onWebSources, onImageAnalysis }) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let eventType = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          if (line.startsWith('event: ')) {
            eventType = line.slice(7).trim();
            continue;
          }
          if (line.startsWith('data: ')) {
            const dataStr = line.slice(6);

            if (eventType === 'sources') {
              try { onSources(JSON.parse(dataStr)); } catch (e) {}
              eventType = '';
              continue;
            }
            if (eventType === 'web_sources') {
              try { if (onWebSources) onWebSources(JSON.parse(dataStr)); } catch (e) {}
              eventType = '';
              continue;
            }
            if (eventType === 'image_analysis') {
              try { if (onImageAnalysis) onImageAnalysis(JSON.parse(dataStr)); } catch (e) {}
              eventType = '';
              continue;
            }
            if (eventType === 'error') {
              try { onError(JSON.parse(dataStr).error || dataStr); } catch (e) { onError(dataStr); }
              eventType = '';
              continue;
            }
            if (eventType === 'done') {
              onDone();
              eventType = '';
              continue;
            }
            // Text chunk
            try {
              const chunk = JSON.parse(dataStr);
              if (chunk.text) onChunk(chunk.text);
            } catch (e) {}
            eventType = '';
          }
        }
      }
    }

    // ========== AI Analyze Panel ==========
    function openAnalyzePanel(itemData) {
      if (!itemData) return;
      const overlay = document.getElementById('ai-analyze-overlay');
      const infoEl = document.getElementById('analyze-article-info');
      const dc = DOMAIN_COLORS[itemData.domain] || DOMAIN_COLORS['Other'];
      const heatColor = getHeatColor(itemData.heat_index || 0);

      infoEl.innerHTML = `
        <div class="flex items-center gap-2 mb-1.5">
          <span class="text-[10px] font-semibold px-2 py-0.5 rounded" style="background:${dc.bg};color:${dc.text}">${itemData.domain || ''}</span>
          <span class="text-xs font-bold" style="color:${heatColor}">${itemData.heat_index || 0}</span>
        </div>
        <p class="text-sm font-semibold text-stone-100 leading-snug">${itemData.title || ''}</p>
      `;

      document.getElementById('analyze-loading').classList.remove('hidden');
      document.getElementById('analyze-result').classList.add('hidden');
      document.getElementById('analyze-result').innerHTML = '';
      document.getElementById('analyze-error').classList.add('hidden');
      document.getElementById('analyze-key-setup').classList.add('hidden');

      // Reset chat state
      chatMessages = [];
      currentAnalysisText = '';
      currentAnalysisItem = itemData;
      if (chatAbort) { chatAbort.abort(); chatAbort = null; }
      document.getElementById('chat-messages-container').innerHTML = '';
      document.getElementById('chat-messages-container').classList.add('hidden');
      document.getElementById('analyze-chat-area').classList.add('hidden');

      overlay.classList.add('open');
      document.body.style.overflow = 'hidden';

      streamAnalysis(itemData);
    }

    function closeAnalyzePanel() {
      const overlay = document.getElementById('ai-analyze-overlay');
      overlay.classList.remove('open');
      document.body.style.overflow = '';
      if (analyzeAbort) { analyzeAbort.abort(); analyzeAbort = null; }
      if (chatAbort) { chatAbort.abort(); chatAbort = null; }
      chatMessages = [];
      currentAnalysisText = '';
      currentAnalysisItem = null;
    }

    async function streamAnalysis(itemData) {
      if (analyzeAbort) { analyzeAbort.abort(); }
      const controller = new AbortController();
      analyzeAbort = controller;
      let fullText = '';

      try {
        const resp = await fetch('/api/ai-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(itemData),
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: () => {},
          onChunk: (text) => {
            fullText += text;
            document.getElementById('analyze-loading').classList.add('hidden');
            const result = document.getElementById('analyze-result');
            result.classList.remove('hidden');
            result.innerHTML = renderMarkdown(fullText) + '<span class="streaming-cursor"></span>';
            const panelContent = document.getElementById('ai-analyze-panel-content');
            panelContent.scrollTop = panelContent.scrollHeight;
          },
          onDone: () => {
            document.getElementById('analyze-result').innerHTML = renderMarkdown(fullText);
            // Save analysis text and show chat area
            if (fullText) {
              currentAnalysisText = fullText;
              document.getElementById('analyze-chat-area').classList.remove('hidden');
              const chatInput = document.getElementById('chat-input');
              chatInput.placeholder = t().chatPlaceholder;
              chatInput.focus();
            }
          },
          onError: (msg) => {
            document.getElementById('analyze-loading').classList.add('hidden');
            if (msg === 'needsApiKey') {
              document.getElementById('analyze-key-setup').classList.remove('hidden');
              // Store item for retry after key save
              document.getElementById('analyze-key-setup').dataset.retryItem = JSON.stringify(itemData);
              return;
            }
            document.getElementById('analyze-error').classList.remove('hidden');
            document.getElementById('analyze-error-text').textContent = msg;
          },
        });

        if (fullText) {
          document.getElementById('analyze-result').innerHTML = renderMarkdown(fullText);
          // Ensure chat shows after SSE completes
          currentAnalysisText = fullText;
          document.getElementById('analyze-chat-area').classList.remove('hidden');
        }
      } catch (e) {
        if (e.name !== 'AbortError') {
          document.getElementById('analyze-loading').classList.add('hidden');
          document.getElementById('analyze-error').classList.remove('hidden');
          document.getElementById('analyze-error-text').textContent = e.message;
        }
      } finally {
        document.getElementById('analyze-loading').classList.add('hidden');
        analyzeAbort = null;
      }
    }

    async function saveApiKeyFromPanel() {
      const input = document.getElementById('analyze-key-input');
      const status = document.getElementById('analyze-key-status');
      const key = input.value.trim();
      if (!key) return;

      try {
        const resp = await fetch('/api/ai-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key }),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          status.textContent = t().aiKeySaved;
          status.className = 'text-xs mt-2 text-emerald-400';
          status.classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('analyze-key-setup').classList.add('hidden');
            status.classList.add('hidden');
            // Retry analysis
            const retryStr = document.getElementById('analyze-key-setup').dataset.retryItem;
            if (retryStr) {
              try { streamAnalysis(JSON.parse(retryStr)); } catch (e) {}
            }
          }, 800);
        } else {
          status.textContent = data.message || t().aiKeySaveError;
          status.className = 'text-xs mt-2 text-red-400';
          status.classList.remove('hidden');
        }
      } catch (e) {
        status.textContent = t().aiKeySaveError + ': ' + e.message;
        status.className = 'text-xs mt-2 text-red-400';
        status.classList.remove('hidden');
      }
    }

    // ========== AI Latest (Trending) ==========
    async function doLatestSearch() {
      // Abort previous
      if (aiSearchAbort) { aiSearchAbort.abort(); aiSearchAbort = null; }

      const latestQuery = t().aiLatestQuery;
      document.getElementById('ai-search-input').value = latestQuery;
      document.getElementById('ai-hero').classList.add('hidden');
      document.getElementById('ai-suggestions').classList.add('hidden');
      document.getElementById('ai-result-area').classList.remove('hidden');
      document.getElementById('ai-query-text').textContent = latestQuery;
      document.getElementById('ai-loading').classList.remove('hidden');
      document.getElementById('ai-error').classList.add('hidden');
      document.getElementById('ai-answer-panel').classList.add('hidden');
      document.getElementById('ai-sources-section').classList.add('hidden');
      document.getElementById('ai-answer-content').innerHTML = '';
      document.getElementById('ai-search-btn').disabled = true;
      document.getElementById('ai-latest-btn').disabled = true;
      document.getElementById('ai-image-btn').disabled = true;
      aiSources = [];

      const controller = new AbortController();
      aiSearchAbort = controller;
      let fullText = '';

      try {
        const resp = await fetch('/api/ai-latest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: '{}',
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: (sources) => {
            aiSources = sources;
            renderAISources(aiSources);
          },
          onWebSources: (webSources) => {
            _mergeWebSources(webSources);
            renderAISources(aiSources);
          },
          onChunk: (text) => {
            fullText += text;
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-answer-panel').classList.remove('hidden');
            renderStreamingMarkdown(fullText);
          },
          onDone: () => {},
          onError: (msg) => {
            showAIError(msg);
          },
        });

        if (fullText) {
          renderFinalMarkdown(fullText);
          filterCitedSources(fullText);
        }
      } catch (e) {
        if (e.name !== 'AbortError') {
          showAIError(e.message);
        }
      } finally {
        document.getElementById('ai-search-btn').disabled = false;
        document.getElementById('ai-latest-btn').disabled = false;
        document.getElementById('ai-image-btn').disabled = false;
        document.getElementById('ai-loading').classList.add('hidden');
        aiSearchAbort = null;
      }
    }

    // ========== Data Loading ==========
    async function loadDomains() {
      const resp = await fetch('/api/domains');
      const domains = await resp.json();

      let total = 0;
      domains.forEach(d => total += d.count);

      // Sidebar domains (desktop)
      const sidebar = document.getElementById('sidebar-domains');
      let sidebarHtml = `<div class="domain-item ${currentDomain === 'All' ? 'active' : ''}" data-domain="All" tabindex="0" role="button">
        <span>${t().allDomain}</span><span class="count">${total}</span>
      </div>`;
      for (const d of domains) {
        const icon = DOMAIN_ICONS[d.domain] || '';
        sidebarHtml += `<div class="domain-item ${currentDomain === d.domain ? 'active' : ''}" data-domain="${d.domain}" tabindex="0" role="button">
          <span>${domainLabel(d.domain)}</span><span class="count">${d.count}</span>
        </div>`;
      }
      sidebar.innerHTML = sidebarHtml;
      sidebar.querySelectorAll('.domain-item').forEach(el => {
        const activate = () => {
          sidebar.querySelectorAll('.domain-item').forEach(e => e.classList.remove('active'));
          el.classList.add('active');
          currentDomain = el.dataset.domain;
          syncMobileDomainActive();
          resetAndLoadItems();
        };
        el.addEventListener('click', activate);
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); activate(); }
        });
      });

      // Mobile domain chips
      const mobile = document.getElementById('mobile-domain-filters');
      const dc0 = currentDomain === 'All' ? 'active' : '';
      let mobileHtml = `<button class="chip ${dc0} px-3 py-1.5 text-xs font-medium border border-white/[.06] bg-stone-800/50 whitespace-nowrap" data-domain="All">${t().allDomain} (${total})</button>`;
      for (const d of domains) {
        const act = currentDomain === d.domain ? 'active' : '';
        mobileHtml += `<button class="chip ${act} px-3 py-1.5 text-xs font-medium border border-white/[.06] bg-stone-800/50 whitespace-nowrap" data-domain="${d.domain}">${domainLabel(d.domain)} (${d.count})</button>`;
      }
      mobile.innerHTML = mobileHtml;
      mobile.querySelectorAll('.chip').forEach(btn => {
        btn.addEventListener('click', () => {
          mobile.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentDomain = btn.dataset.domain;
          // sync sidebar
          syncSidebarDomainActive();
          resetAndLoadItems();
        });
      });
    }

    function syncSidebarDomainActive() {
      document.querySelectorAll('#sidebar-domains .domain-item').forEach(el => {
        el.classList.toggle('active', el.dataset.domain === currentDomain);
      });
    }

    function syncMobileDomainActive() {
      document.querySelectorAll('#mobile-domain-filters .chip').forEach(el => {
        el.classList.toggle('active', el.dataset.domain === currentDomain);
      });
    }

    function resetAndLoadItems() {
      currentOffset = 0;
      const skeletonHtml = Array.from({length:6}, () => `<div class="skeleton-card"><div class="skeleton-line" style="width:60px;height:22px;margin-bottom:12px"></div><div class="skeleton-line" style="width:85%;height:14px;margin-bottom:8px"></div><div class="skeleton-line" style="width:65%;height:14px;margin-bottom:16px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:8px"></div><div class="skeleton-line" style="width:100%;height:10px;margin-bottom:12px"></div><div class="skeleton-line" style="width:100%;height:2px;margin-bottom:12px"></div><div style="display:flex;gap:8px"><div class="skeleton-line" style="width:44px;height:18px;border-radius:6px"></div><div class="skeleton-line" style="width:30px;height:18px;border-radius:6px"></div></div></div>`).join('');
      document.getElementById('items-grid').innerHTML = skeletonHtml;
      loadItems(false);
    }

    async function loadItems(append = false) {
      const params = new URLSearchParams();
      if (currentDomain !== 'All') params.set('domain', currentDomain);
      if (currentSearch) params.set('search', currentSearch);
      params.set('sort', currentSort);
      params.set('limit', PAGE_SIZE);
      params.set('offset', currentOffset);

      const resp = await fetch(`/api/items?${params}`);
      const data = await resp.json();
      const items = data.items;
      totalItems = data.total;

      const grid = document.getElementById('items-grid');
      const empty = document.getElementById('empty-state');
      const countEl = document.getElementById('item-count');
      const loadMoreContainer = document.getElementById('load-more-container');
      const shownCountEl = document.getElementById('shown-count');
      const loadMoreBtn = document.getElementById('load-more-btn');

      if (!append && items.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        loadMoreContainer.classList.add('hidden');
        countEl.textContent = t().itemCount(0);
        return;
      }

      empty.classList.add('hidden');
      countEl.textContent = t().itemCount(totalItems);

      const newHtml = items.map(renderCard).join('');
      if (append) {
        grid.insertAdjacentHTML('beforeend', newHtml);
      } else {
        grid.innerHTML = newHtml;
      }

      // Stagger card entry animations
      requestAnimationFrame(() => {
        const cards = grid.querySelectorAll('.card-stagger');
        const startIdx = append ? cards.length - items.length : 0;
        for (let i = startIdx; i < cards.length; i++) {
          const delay = Math.min((i - startIdx) * 40, 600);
          cards[i].style.animationDelay = delay + 'ms';
        }
      });

      const shownSoFar = currentOffset + items.length;
      if (shownSoFar < totalItems) {
        loadMoreContainer.classList.remove('hidden');
        loadMoreBtn.classList.remove('hidden');
        shownCountEl.textContent = t().shownCount(shownSoFar, totalItems);
      } else {
        loadMoreContainer.classList.remove('hidden');
        shownCountEl.textContent = t().shownCount(shownSoFar, totalItems);
        loadMoreBtn.classList.add('hidden');
      }

      if (translateMode && items.length > 0) {
        await translateVisibleCards();
      }
    }

    async function loadMore() {
      currentOffset += PAGE_SIZE;
      await loadItems(true);
    }

    function animateCount(el, target, duration = 800) {
      const start = parseInt(el.textContent.replace(/,/g, ''), 10) || 0;
      if (start === target) return;
      const startTime = performance.now();
      function tick(now) {
        const elapsed = now - startTime;
        const progress = Math.min(elapsed / duration, 1);
        // ease-out cubic
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = Math.round(start + (target - start) * eased);
        el.textContent = current.toLocaleString();
        if (progress < 1) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    }

    async function loadStats() {
      const resp = await fetch('/api/stats');
      const stats = await resp.json();
      animateCount(document.getElementById('kpi-raw'), stats.raw_items || 0);
      animateCount(document.getElementById('kpi-clean'), stats.cleaned_items || 0, 900);
      animateCount(document.getElementById('kpi-classified'), stats.classified_items || 0, 1000);
    }

    // ========== Trend Tracking ==========
    async function loadTrends() {
      const titleEl = document.getElementById('trend-title');
      const listEl = document.getElementById('trend-list');
      if (!titleEl || !listEl) return;

      titleEl.textContent = t().trendTitle;

      try {
        const resp = await fetch('/api/trends?limit=5');
        const data = await resp.json();

        if (!data.items || data.items.length === 0) {
          listEl.innerHTML = `<div class="text-xs text-stone-500 px-2">${t().trendEmpty}</div>`;
          return;
        }

        listEl.innerHTML = data.items.map(item => {
          const arrowSvg = item.direction === 'up'
            ? '<svg class="w-3 h-3" fill="none" stroke="#22c55e" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 15l7-7 7 7"/></svg>'
            : item.direction === 'down'
            ? '<svg class="w-3 h-3" fill="none" stroke="#ef4444" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/></svg>'
            : '<svg class="w-3 h-3" fill="none" stroke="#a8a29e" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 12h14"/></svg>';
          const color = item.direction === 'up' ? '#22c55e' : item.direction === 'down' ? '#ef4444' : '#a8a29e';
          const bgTint = item.direction === 'up' ? 'rgba(34,197,94,.06)' : item.direction === 'down' ? 'rgba(239,68,68,.06)' : 'transparent';
          const absDelta = Math.abs(item.delta);
          const title = item.title.length > 28 ? item.title.substring(0, 28) + '...' : item.title;
          const barWidth = Math.min(item.heat_index, 100);

          return `
            <div class="px-2 py-1.5 rounded-lg hover:bg-white/[.03] transition-colors cursor-default" title="${item.title}" style="background:${bgTint}">
              <div class="flex items-center justify-between gap-2">
                <span class="text-xs text-stone-300 truncate flex-1">${title}</span>
                <span class="flex items-center gap-1 text-xs font-bold text-mono" style="color:${color}">${arrowSvg} ${absDelta}</span>
              </div>
              <div class="mt-1 h-[2px] rounded-full bg-stone-800 overflow-hidden">
                <div class="h-full rounded-full" style="width:${barWidth}%;background:linear-gradient(90deg,#b08d57,#d97706)"></div>
              </div>
            </div>`;
        }).join('');
      } catch (e) {
        listEl.innerHTML = `<div class="text-xs text-stone-500 px-2">${t().trendEmpty}</div>`;
      }
    }

    // ========== Events ==========
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        currentSearch = e.target.value.trim();
        resetAndLoadItems();
      }, 300);
    });

    // ========== Scheduler Status ==========
    async function loadSchedulerStatus() {
      const labelEl = document.getElementById('scheduler-label');
      const statusEl = document.getElementById('scheduler-status');
      if (!labelEl || !statusEl) return;

      labelEl.textContent = t().schedulerStatus;

      try {
        const resp = await fetch('/api/scheduler');
        const data = await resp.json();

        if (!data.running) {
          statusEl.innerHTML = `<span class="text-stone-600">${t().schedulerOff}</span>`;
          return;
        }

        const collectJob = (data.jobs || []).find(j => j.id === 'daily_collect');
        let nextRun = '';
        if (collectJob && collectJob.next_run) {
          const d = new Date(collectJob.next_run);
          nextRun = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
        }

        statusEl.innerHTML = `
          <div class="flex items-center gap-1.5 mb-1">
            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
            <span class="text-green-400">${t().schedulerRunning}</span>
          </div>
          ${nextRun ? `<div class="text-stone-500">${t().schedulerNext}: ${nextRun}</div>` : ''}
        `;
      } catch (e) {
        statusEl.innerHTML = `<span class="text-stone-600">${t().schedulerOff}</span>`;
      }
    }

    // ========== Single Article Export ==========
    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    async function exportSingleArticle(itemData, btnEl) {
      const tags = (itemData.tags || []).join(', ');
      const sources = (itemData.sources || []).join(', ');
      let desc = itemData.description || '';

      // Try to fetch full article content from the original URL
      if (itemData.url) {
        if (btnEl) {
          btnEl.textContent = lang === 'zh' ? '抓取中...' : 'Fetching...';
          btnEl.disabled = true;
        }
        try {
          const resp = await fetch('/api/fetch-content', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: itemData.url }),
          });
          if (resp.ok) {
            const data = await resp.json();
            if (data.content && data.content.length > desc.length) {
              desc = data.content;
            }
          }
        } catch (_) { /* fallback to original description */ }
      }

      const md = [
        `# ${itemData.title || 'Untitled'}`,
        '',
        `**${lang === 'zh' ? '领域' : 'Domain'}**: ${itemData.domain || ''} | **${lang === 'zh' ? '热度' : 'Heat'}**: ${itemData.heat_index || 0} | **Stars**: ${itemData.stars || 0}`,
        `**${lang === 'zh' ? '来源' : 'Source'}**: ${sources} | **${lang === 'zh' ? '标签' : 'Tags'}**: ${tags}`,
        `**URL**: ${itemData.url || ''}`,
        '',
        '---',
        '',
        `## ${lang === 'zh' ? '内容' : 'Content'}`,
        '',
        desc,
        '',
        '---',
        '',
        `*Exported from InsightRadar — ${new Date().toLocaleDateString()}*`,
      ].join('\n');

      const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const safeName = (itemData.title || 'article').replace(/[^a-zA-Z0-9\u4e00-\u9fff-_ ]/g, '').substring(0, 50).trim();
      a.href = url;
      a.download = `${safeName}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      if (btnEl) {
        btnEl.textContent = t().exportArticleDone;
        btnEl.disabled = true;
        setTimeout(() => { btnEl.textContent = t().exportArticleBtn; btnEl.disabled = false; }, 1500);
      }
    }

    // ========== Chat ==========
    async function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const sendBtn = document.getElementById('chat-send-btn');
      const msg = input.value.trim();
      if (!msg || !currentAnalysisItem) return;

      input.value = '';
      input.disabled = true;
      sendBtn.disabled = true;

      // Add user bubble
      chatMessages.push({ role: 'user', content: msg });
      const container = document.getElementById('chat-messages-container');
      container.classList.remove('hidden');
      const userBubble = document.createElement('div');
      userBubble.className = 'chat-bubble user';
      userBubble.textContent = msg;
      container.appendChild(userBubble);

      // Add thinking bubble
      const asstBubble = document.createElement('div');
      asstBubble.className = 'chat-bubble assistant';
      asstBubble.innerHTML = `<span class="text-xs text-stone-500">${t().chatThinking}</span><span class="streaming-cursor"></span>`;
      container.appendChild(asstBubble);

      // Scroll to bottom
      const panelContent = document.getElementById('ai-analyze-panel-content');
      panelContent.scrollTop = panelContent.scrollHeight;

      if (chatAbort) chatAbort.abort();
      const controller = new AbortController();
      chatAbort = controller;
      let fullReply = '';

      try {
        const resp = await fetch('/api/ai-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            article: currentAnalysisItem,
            initial_analysis: currentAnalysisText,
            messages: chatMessages,
          }),
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: () => {},
          onChunk: (text) => {
            fullReply += text;
            asstBubble.innerHTML = renderMarkdown(fullReply) + '<span class="streaming-cursor"></span>';
            panelContent.scrollTop = panelContent.scrollHeight;
          },
          onDone: () => {
            asstBubble.innerHTML = renderMarkdown(fullReply);
          },
          onError: (errMsg) => {
            asstBubble.innerHTML = `<span class="text-red-400 text-xs">${escapeHtml(errMsg)}</span>`;
          },
        });

        if (fullReply) {
          asstBubble.innerHTML = renderMarkdown(fullReply);
          chatMessages.push({ role: 'assistant', content: fullReply });
        }
      } catch (e) {
        if (e.name !== 'AbortError') {
          asstBubble.innerHTML = `<span class="text-red-400 text-xs">${escapeHtml(e.message)}</span>`;
        }
      } finally {
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
        chatAbort = null;
        panelContent.scrollTop = panelContent.scrollHeight;
      }
    }

    // ========== WebSocket Auto-Refresh ==========
    let wsReconnectDelay = 3000;
    let wsReconnectTimer = null;
    let ws = null;

    function connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      try {
        ws = new WebSocket(`${protocol}//${location.host}/api/ws`);
      } catch (e) { return; }

      ws.addEventListener('open', () => {
        wsReconnectDelay = 3000;
        const dot = document.getElementById('ws-live-dot');
        dot.classList.remove('disconnected');
        dot.classList.add('connected');
        dot.title = t().wsConnected;
      });

      ws.addEventListener('message', (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          if (msg.type === 'collection_complete') {
            if (feedLoaded) {
              loadDomains();
              loadItems(false);
              loadStats();
              loadTrends();
            }
            showToast(t().wsNewData, 'success');
          }
        } catch (e) {}
      });

      ws.addEventListener('close', () => {
        const dot = document.getElementById('ws-live-dot');
        dot.classList.remove('connected');
        dot.classList.add('disconnected');
        dot.title = t().wsDisconnected;
        scheduleWsReconnect();
      });

      ws.addEventListener('error', () => {
        // error fires before close; close handler will schedule reconnect
      });
    }

    function scheduleWsReconnect() {
      if (wsReconnectTimer) return;
      wsReconnectTimer = setTimeout(() => {
        wsReconnectTimer = null;
        connectWebSocket();
        wsReconnectDelay = Math.min(wsReconnectDelay * 2, 30000);
      }, wsReconnectDelay);
    }

    // ========== User Preferences Sync ==========
    async function loadPreferences() {
      try {
        const resp = await fetch('/api/preferences');
        if (!resp.ok) return;
        const prefs = await resp.json();
        if (prefs.language && (prefs.language === 'zh' || prefs.language === 'en')) {
          lang = prefs.language;
          localStorage.setItem('ir-lang', lang);
          document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
        }
        if (prefs.sort) currentSort = prefs.sort;
        if (prefs.view && (prefs.view === 'ai-search' || prefs.view === 'feed')) {
          currentView = prefs.view;
        }
        if (prefs.items_per_page && Number.isFinite(prefs.items_per_page)) {
          PAGE_SIZE = prefs.items_per_page;
        }
      } catch (e) {}
    }

    function savePreference(key, value) {
      fetch('/api/preferences', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [key]: value }),
      }).catch(() => {});
    }

    // ========== Feed Health ==========
    async function loadFeedHealth() {
      const labelEl = document.getElementById('feed-health-label');
      const listEl = document.getElementById('feed-health-list');
      if (!labelEl || !listEl) return;

      labelEl.textContent = t().feedHealth;

      try {
        const resp = await fetch('/api/feed-health');
        if (!resp.ok) { listEl.innerHTML = ''; return; }
        const data = await resp.json();
        const sources = data.sources || data;
        if (!Array.isArray(sources) || sources.length === 0) {
          listEl.innerHTML = '';
          return;
        }

        listEl.innerHTML = sources.map(src => {
          let statusClass = 'unknown';
          let statusText = t().feedUnknown;
          if (src.last_success) {
            const hoursSince = (Date.now() - new Date(src.last_success).getTime()) / 3600000;
            if (hoursSince <= 24) { statusClass = 'healthy'; statusText = t().feedHealthy; }
            else if (hoursSince <= 72) { statusClass = 'stale'; statusText = t().feedStale; }
            else { statusClass = 'dead'; statusText = t().feedDead; }
          } else {
            statusClass = 'dead'; statusText = t().feedDead;
          }
          const ago = src.last_success ? timeAgo(src.last_success) : '—';
          return `
            <div class="flex items-center gap-2 px-1 py-1">
              <span class="feed-health-dot ${statusClass}"></span>
              <span class="text-xs text-stone-300 flex-1 truncate">${src.name || src.source}</span>
              <span class="text-[10px] text-stone-500">${ago}</span>
            </div>`;
        }).join('');
      } catch (e) {
        listEl.innerHTML = '';
      }
    }

    // ========== System Health Indicator ==========
    async function checkSystemHealth() {
      const dot = document.getElementById('health-dot');
      if (!dot) return;
      try {
        const resp = await fetch('/api/health');
        if (!resp.ok) throw new Error();
        const data = await resp.json();
        const status = data.status || 'ok';
        dot.className = 'health-dot ' + (status === 'ok' ? 'ok' : 'degraded');
        const dbStatus = data.database || data.db || '?';
        const schedStatus = data.scheduler || '?';
        dot.title = status === 'ok' ? t().healthOk : t().healthDegraded;
        dot.title += ` | ${t().healthDb}: ${dbStatus} | ${t().healthSched}: ${schedStatus}`;
      } catch (e) {
        dot.className = 'health-dot error';
        dot.title = t().healthError;
      }
    }

    // ========== FTS Search Upgrade ==========
    // Patch loadItems to use /api/search (FTS) when no domain filter is active
    const _origLoadItems = loadItems;
    loadItems = async function(append = false) {
      // Use FTS endpoint when: there's a search query AND no domain filter
      if (currentSearch && currentDomain === 'All') {
        const params = new URLSearchParams();
        params.set('q', currentSearch);
        params.set('sort', currentSort);
        params.set('limit', PAGE_SIZE);
        params.set('offset', currentOffset);

        try {
          const resp = await fetch(`/api/search?${params}`);
          if (resp.ok) {
            const data = await resp.json();
            const items = data.items || [];
            totalItems = data.total || items.length;

            const grid = document.getElementById('items-grid');
            const empty = document.getElementById('empty-state');
            const countEl = document.getElementById('item-count');
            const loadMoreContainer = document.getElementById('load-more-container');
            const shownCountEl = document.getElementById('shown-count');
            const loadMoreBtn = document.getElementById('load-more-btn');

            if (!append && items.length === 0) {
              grid.innerHTML = '';
              empty.classList.remove('hidden');
              loadMoreContainer.classList.add('hidden');
              countEl.textContent = t().itemCount(0);
              return;
            }
            empty.classList.add('hidden');
            countEl.textContent = t().itemCount(totalItems);

            const newHtml = items.map(renderCard).join('');
            if (append) { grid.insertAdjacentHTML('beforeend', newHtml); }
            else { grid.innerHTML = newHtml; }

            requestAnimationFrame(() => {
              const cards = grid.querySelectorAll('.card-stagger');
              const startIdx = append ? cards.length - items.length : 0;
              for (let i = startIdx; i < cards.length; i++) {
                cards[i].style.animationDelay = Math.min((i - startIdx) * 40, 600) + 'ms';
              }
            });

            const shownSoFar = currentOffset + items.length;
            if (shownSoFar < totalItems) {
              loadMoreContainer.classList.remove('hidden');
              loadMoreBtn.classList.remove('hidden');
              shownCountEl.textContent = t().shownCount(shownSoFar, totalItems);
            } else {
              loadMoreContainer.classList.remove('hidden');
              shownCountEl.textContent = t().shownCount(shownSoFar, totalItems);
              loadMoreBtn.classList.add('hidden');
            }

            if (translateMode && items.length > 0) await translateVisibleCards();
            return;
          }
        } catch (e) {}
        // Fallback to original /api/items if FTS fails
      }
      return _origLoadItems(append);
    };

    // ========== Preference-aware wrappers ==========
    const _origSetLang = setLang;
    setLang = function(l) {
      _origSetLang(l);
      savePreference('language', l);
    };

    // Save sort preference on change
    document.getElementById('sort-select').addEventListener('change', (e) => {
      currentSort = e.target.value;
      savePreference('sort', currentSort);
      resetAndLoadItems();
    });

    // Save view preference on switch
    const _origSwitchView = switchView;
    switchView = function(view) {
      _origSwitchView(view);
      savePreference('view', view);
    };

    // ========== Init ==========
    (async function init() {
      // Load preferences first, then apply
      await loadPreferences();
      applyLang();
      switchView(currentView);
      loadSchedulerStatus();
      loadFeedHealth();
      checkSystemHealth();
      setInterval(checkSystemHealth, 60000);

      // Paste image support: Ctrl+V in search input
      const searchInput = document.getElementById('ai-search-input');
      searchInput.addEventListener('paste', (e) => {
        const items = e.clipboardData?.items;
        if (!items) return;
        for (const item of items) {
          if (item.type.startsWith('image/')) {
            e.preventDefault();
            processImageFile(item.getAsFile());
            return;
          }
        }
      });

      // Drag & drop image support on search box
      const searchBox = document.querySelector('.ai-search-box');
      searchBox.addEventListener('dragover', (e) => {
        e.preventDefault();
        searchBox.classList.add('drag-over');
      });
      searchBox.addEventListener('dragleave', (e) => {
        if (!searchBox.contains(e.relatedTarget)) {
          searchBox.classList.remove('drag-over');
        }
      });
      searchBox.addEventListener('drop', (e) => {
        e.preventDefault();
        searchBox.classList.remove('drag-over');
        const file = e.dataTransfer?.files?.[0];
        if (file && file.type.startsWith('image/')) {
          processImageFile(file);
        }
      });

      connectWebSocket();
    })();
  </script>
</body>
</html>
