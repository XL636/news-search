<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InsightRadar Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            surface: { 50: '#faf8f5', 100: '#f0ede8', 800: '#1f1e1b', 900: '#171613', 950: '#12110f' },
          },
        },
      },
    }
  </script>
  <style>
    /* === Base === */
    body { background: #12110f; color: #d4d0c8; }
    ::selection { background: rgba(217,119,6,.3); }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #2a2825; border-radius: 3px; }

    /* === Glass === */
    .glass { background: rgba(22, 21, 18, .7); backdrop-filter: blur(16px) saturate(180%); border: 1px solid rgba(168,162,150,.08); }
    .glass-light { background: rgba(38, 35, 28, .4); backdrop-filter: blur(12px); border: 1px solid rgba(168,162,150,.06); }

    /* === Cards === */
    .card { background: rgba(26, 25, 22, .6); border: 1px solid rgba(168,162,150,.06); border-radius: 16px; transition: all .25s cubic-bezier(.4,0,.2,1); }
    .card:hover { border-color: rgba(217,119,6,.25); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,.3), 0 0 0 1px rgba(217,119,6,.08); }
    .card-hot { border-left: 3px solid #ef4444; }

    /* === Chips === */
    .chip { transition: all .2s; border-radius: 10px; }
    .chip:hover { background: rgba(217,119,6,.1); border-color: rgba(217,119,6,.25); }
    .chip.active { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; border-color: transparent; box-shadow: 0 2px 12px rgba(217,119,6,.3); }

    /* === KPI Cards === */
    .kpi-card { background: linear-gradient(135deg, rgba(38,35,28,.6), rgba(22,21,18,.8)); border: 1px solid rgba(168,162,150,.08); border-radius: 16px; transition: all .25s; }
    .kpi-card:hover { border-color: rgba(217,119,6,.2); }
    .kpi-value { background: linear-gradient(135deg, #e7e5e0, #a8a29e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    /* === Animations === */
    .fade-in { animation: fadeIn .4s cubic-bezier(.4,0,.2,1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .skeleton { background: linear-gradient(90deg, rgba(38,35,28,.5) 25%, rgba(55,50,42,.5) 50%, rgba(38,35,28,.5) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 16px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }

    /* === Heat Bar === */
    .heat-bar-bg { height: 3px; border-radius: 2px; background: rgba(38,35,28,.8); }
    .heat-bar-fill { height: 3px; border-radius: 2px; transition: width .6s cubic-bezier(.4,0,.2,1); }

    /* === Source Badges === */
    .source-badge { font-size: 10px; padding: 2px 7px; border-radius: 6px; font-weight: 500; letter-spacing: .3px; }

    /* === Tags === */
    .tag-pill { font-size: 10px; padding: 2px 8px; border-radius: 8px; background: rgba(38,35,28,.8); color: #a8a29e; border: 1px solid rgba(168,162,150,.08); }

    /* === Details === */
    .details-content { max-height: 0; overflow: hidden; transition: max-height .3s cubic-bezier(.4,0,.2,1); }
    .details-content.open { max-height: 500px; }

    /* === Toast === */
    .toast-enter { animation: toastIn .3s cubic-bezier(.4,0,.2,1); }
    @keyframes toastIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
    .toast-exit { animation: toastOut .3s ease forwards; }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(50px); } }

    /* === Button === */
    .btn-ghost { border: 1px solid rgba(168,162,150,.12); background: rgba(38,35,28,.3); color: #a8a29e; transition: all .2s; border-radius: 10px; }
    .btn-ghost:hover { border-color: rgba(217,119,6,.3); color: #fde68a; background: rgba(217,119,6,.08); }
    .btn-ghost.active { background: rgba(217,119,6,.15); border-color: rgba(217,119,6,.4); color: #fbbf24; }

    /* === Lang Toggle === */
    .lang-toggle { background: rgba(38,35,28,.5); border: 1px solid rgba(168,162,150,.08); border-radius: 10px; padding: 2px; }
    .lang-btn { transition: all .2s; border-radius: 8px; }
    .lang-btn.active { background: rgba(217,119,6,.8); color: #fff; }

    /* === Gradient Orbs (ambient background) === */
    .orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: .12; pointer-events: none; z-index: 0; }
    .orb-1 { width: 600px; height: 600px; background: #d97706; top: -200px; right: -200px; }
    .orb-2 { width: 400px; height: 400px; background: #92400e; bottom: -100px; left: -150px; }

    /* === Sidebar domain list === */
    .domain-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: all .2s; font-size: 13px; color: #a8a29e; }
    .domain-item:hover { background: rgba(217,119,6,.08); color: #fde68a; }
    .domain-item.active { background: rgba(217,119,6,.12); color: #fbbf24; font-weight: 600; }
    .domain-item .count { font-size: 11px; background: rgba(38,35,28,.8); padding: 1px 8px; border-radius: 8px; color: #78716c; }
    .domain-item.active .count { background: rgba(217,119,6,.2); color: #fbbf24; }

    /* === Tab Navigation === */
    .tab-nav { background: rgba(38,35,28,.5); border: 1px solid rgba(168,162,150,.08); border-radius: 10px; padding: 2px; }
    .tab-btn { transition: all .2s; border-radius: 8px; padding: 6px 14px; font-size: 12px; font-weight: 500; color: #a8a29e; cursor: pointer; white-space: nowrap; }
    .tab-btn:hover { color: #fde68a; }
    .tab-btn.active { background: rgba(217,119,6,.8); color: #fff; box-shadow: 0 2px 8px rgba(217,119,6,.25); }

    /* === View Toggle === */
    .view.hidden { display: none !important; }

    /* === AI Search === */
    .ai-hero-icon { width: 64px; height: 64px; border-radius: 20px; background: linear-gradient(135deg, #d97706, #b45309, #92400e); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(217,119,6,.3); }
    .ai-search-box { background: rgba(22,21,18,.6); backdrop-filter: blur(16px); border: 1px solid rgba(168,162,150,.1); border-radius: 16px; transition: border-color .2s; }
    .ai-search-box:focus-within { border-color: rgba(217,119,6,.4); box-shadow: 0 0 0 3px rgba(217,119,6,.1); }
    .ai-search-input { background: transparent; border: none; outline: none; color: #e7e5e0; font-size: 15px; width: 100%; }
    .ai-search-input::placeholder { color: #57534e; }
    .ai-search-btn { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; border: none; border-radius: 12px; padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; white-space: nowrap; }
    .ai-search-btn:hover { box-shadow: 0 4px 16px rgba(217,119,6,.4); transform: translateY(-1px); }
    .ai-search-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }

    .suggestion-chip { background: rgba(38,35,28,.5); border: 1px solid rgba(168,162,150,.08); border-radius: 10px; padding: 6px 14px; font-size: 12px; color: #a8a29e; cursor: pointer; transition: all .2s; }
    .suggestion-chip:hover { background: rgba(217,119,6,.1); border-color: rgba(217,119,6,.25); color: #fde68a; }

    /* AI Answer */
    .ai-answer-panel { background: rgba(22,21,18,.5); border: 1px solid rgba(168,162,150,.06); border-radius: 16px; }
    #ai-answer-content h3 { font-size: 15px; font-weight: 700; color: #e7e5e0; margin: 20px 0 8px 0; }
    #ai-answer-content h3:first-child { margin-top: 0; }
    #ai-answer-content p { font-size: 14px; line-height: 1.75; color: #d4d0c8; margin: 8px 0; }
    #ai-answer-content ul { margin: 8px 0; padding-left: 20px; }
    #ai-answer-content li { font-size: 14px; line-height: 1.75; color: #d4d0c8; margin: 4px 0; }
    #ai-answer-content strong { color: #e7e5e0; }
    #ai-answer-content a { color: #fbbf24; text-decoration: underline; text-underline-offset: 2px; }

    .citation { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; font-size: 10px; font-weight: 700; background: rgba(217,119,6,.2); color: #fbbf24; border-radius: 5px; cursor: pointer; vertical-align: super; margin: 0 1px; transition: all .15s; line-height: 1; }
    .citation:hover { background: rgba(217,119,6,.4); color: #fff; }

    .ai-source-card { background: rgba(38,35,28,.4); border: 1px solid rgba(168,162,150,.06); border-radius: 12px; padding: 14px; transition: all .2s; cursor: pointer; }
    .ai-source-card:hover { border-color: rgba(217,119,6,.3); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,.2); }
    .ai-source-card.highlight { border-color: rgba(217,119,6,.5); box-shadow: 0 0 0 2px rgba(217,119,6,.15); }
    .ai-source-card.web-source { border-left: 2px solid rgba(59,130,246,.3); }

    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .streaming-cursor { display: inline-block; width: 2px; height: 16px; background: #fbbf24; margin-left: 2px; vertical-align: text-bottom; animation: blink .8s step-end infinite; }

    .ai-loading-dots span { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #d97706; margin: 0 3px; animation: pulse-dot 1.2s ease-in-out infinite; }
    .ai-loading-dots span:nth-child(2) { animation-delay: .2s; }
    .ai-loading-dots span:nth-child(3) { animation-delay: .4s; }

    /* === AI Analyze Button on Cards === */
    .btn-ai-analyze { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: rgba(217,119,6,.1); color: #fbbf24; border: 1px solid rgba(217,119,6,.2); cursor: pointer; transition: all .2s; font-weight: 600; white-space: nowrap; }
    .btn-ai-analyze:hover { background: rgba(217,119,6,.25); border-color: rgba(217,119,6,.4); color: #fff; }

    /* === AI Analyze Overlay + Slide Panel === */
    #ai-analyze-overlay { position: fixed; inset: 0; z-index: 200; pointer-events: none; opacity: 0; transition: opacity .3s; }
    #ai-analyze-overlay.open { pointer-events: auto; opacity: 1; }
    #ai-analyze-overlay .overlay-bg { position: absolute; inset: 0; background: rgba(0,0,0,.5); }
    #ai-analyze-panel { position: absolute; top: 0; right: 0; width: 480px; max-width: 100vw; height: 100vh; background: #16150f; border-left: 1px solid rgba(168,162,150,.08); transform: translateX(100%); transition: transform .35s cubic-bezier(.4,0,.2,1); display: flex; flex-direction: column; overflow: hidden; }
    #ai-analyze-overlay.open #ai-analyze-panel { transform: translateX(0); }
    #ai-analyze-panel-content { flex: 1; overflow-y: auto; padding: 20px 24px; }
    #ai-analyze-panel-content h3 { font-size: 15px; font-weight: 700; color: #e7e5e0; margin: 20px 0 8px 0; }
    #ai-analyze-panel-content h3:first-child { margin-top: 0; }
    #ai-analyze-panel-content p { font-size: 14px; line-height: 1.75; color: #d4d0c8; margin: 8px 0; }
    #ai-analyze-panel-content ul { margin: 8px 0; padding-left: 20px; }
    #ai-analyze-panel-content li { font-size: 14px; line-height: 1.75; color: #d4d0c8; margin: 4px 0; }
    #ai-analyze-panel-content strong { color: #e7e5e0; }

    /* === Lightning Button === */
    .ai-latest-btn { background: rgba(217,119,6,.12); color: #fbbf24; border: 1px solid rgba(217,119,6,.25); border-radius: 12px; padding: 10px 16px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all .2s; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
    .ai-latest-btn:hover { background: rgba(217,119,6,.2); border-color: rgba(217,119,6,.4); box-shadow: 0 4px 16px rgba(217,119,6,.2); transform: translateY(-1px); }
    .ai-latest-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; box-shadow: none; }

    /* === Responsive === */
    @media (max-width: 1023px) {
      .sidebar { display: none !important; }
      .mobile-domain-bar { display: flex !important; }
    }
    @media (min-width: 1024px) {
      .mobile-domain-bar { display: none !important; }
    }
    @media (max-width: 640px) {
      #ai-analyze-panel { width: 100vw; }
    }
  </style>
</head>
<body class="min-h-screen relative overflow-x-hidden">
  <!-- Ambient Background Orbs -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2"></div>

  <!-- Header -->
  <header class="glass sticky top-0 z-50 border-b border-white/[.04]">
    <div class="max-w-[1400px] mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center font-bold text-white text-sm shadow-lg shadow-amber-500/20">IR</div>
        <div>
          <h1 class="text-base font-bold text-white tracking-tight">InsightRadar</h1>
          <p id="subtitle" class="text-[10px] text-stone-500 font-medium tracking-wide uppercase"></p>
        </div>
      </div>

      <!-- Center: Tab Navigation -->
      <div class="tab-nav flex items-center">
        <button class="tab-btn active" data-view="ai-search" onclick="switchView('ai-search')">
          <span id="tab-ai-search-text"></span>
        </button>
        <button class="tab-btn" data-view="feed" onclick="switchView('feed')">
          <span id="tab-feed-text"></span>
        </button>
      </div>

      <div class="flex items-center gap-2">
        <!-- Refresh (feed only) -->
        <button id="refresh-btn" onclick="doRefresh()" class="btn-ghost flex items-center gap-1.5 px-3 py-2 text-xs font-medium">
          <svg id="refresh-icon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span id="refresh-text" class="hidden sm:inline"></span>
        </button>
        <!-- Transtone (feed only) -->
        <button id="translate-btn" onclick="toggleTranstone()" class="btn-ghost flex items-center gap-1.5 px-3 py-2 text-xs font-medium feed-only-btn hidden">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
          </svg>
          <span id="translate-text" class="hidden sm:inline"></span>
        </button>
        <!-- Language -->
        <div class="lang-toggle flex items-center">
          <button class="lang-btn px-2.5 py-1.5 text-[11px] font-medium text-stone-400" data-lang="zh" onclick="setLang('zh')">中文</button>
          <button class="lang-btn px-2.5 py-1.5 text-[11px] font-medium text-stone-400" data-lang="en" onclick="setLang('en')">EN</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ============ AI Search View ============ -->
  <div id="view-ai-search" class="view">
    <div class="max-w-[860px] mx-auto px-4 lg:px-6 py-8 relative z-10">
      <!-- Hero -->
      <div id="ai-hero" class="text-center mb-8 fade-in">
        <div class="ai-hero-icon mx-auto mb-5">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456z"/>
          </svg>
        </div>
        <h2 id="ai-greeting" class="text-2xl font-bold text-white mb-2"></h2>
        <p id="ai-subtitle-text" class="text-sm text-stone-400"></p>
      </div>

      <!-- Search Input -->
      <div class="ai-search-box flex items-center gap-3 p-2 pl-5 mb-5">
        <svg class="w-5 h-5 text-stone-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input id="ai-search-input" type="text" class="ai-search-input flex-1 py-2"
               onkeydown="if(event.key==='Enter')doAISearch()">
        <button id="ai-latest-btn" onclick="doLatestSearch()" class="ai-latest-btn">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          <span id="ai-latest-btn-text"></span>
        </button>
        <button id="ai-search-btn" onclick="doAISearch()" class="ai-search-btn"></button>
      </div>

      <!-- Suggestions -->
      <div id="ai-suggestions" class="flex flex-wrap gap-2 justify-center mb-8">
        <!-- filled by JS -->
      </div>

      <!-- AI Result Area -->
      <div id="ai-result-area" class="hidden fade-in">
        <!-- Query display -->
        <div id="ai-query-display" class="flex items-center gap-2 mb-5">
          <span class="text-sm text-stone-400" id="ai-query-label"></span>
          <span id="ai-query-text" class="text-sm font-medium text-white"></span>
          <button onclick="resetAISearch()" class="ml-auto text-xs text-amber-400 hover:text-amber-300 transition-colors" id="ai-new-search-btn"></button>
        </div>

        <!-- Loading -->
        <div id="ai-loading" class="hidden text-center py-12">
          <div class="ai-loading-dots mb-3"><span></span><span></span><span></span></div>
          <p id="ai-loading-text" class="text-sm text-stone-500"></p>
        </div>

        <!-- Error -->
        <div id="ai-error" class="hidden text-center py-12">
          <div class="w-12 h-12 mx-auto mb-3 rounded-xl bg-red-900/30 flex items-center justify-center">
            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
            </svg>
          </div>
          <p id="ai-error-text" class="text-sm text-red-300"></p>
        </div>

        <!-- API Key Setup -->
        <div id="ai-key-setup" class="hidden">
          <div class="ai-answer-panel p-6 max-w-lg mx-auto">
            <div class="flex items-center gap-2.5 mb-4">
              <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/>
                </svg>
              </div>
              <span id="ai-key-title" class="text-sm font-semibold text-white"></span>
            </div>
            <p id="ai-key-desc" class="text-xs text-stone-400 mb-4"></p>
            <div class="flex gap-2">
              <input id="ai-key-input" type="password"
                     class="flex-1 px-4 py-2.5 bg-stone-900/50 border border-white/[.06] rounded-xl text-sm text-stone-200 placeholder-stone-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/30 transition-all"
                     onkeydown="if(event.key==='Enter')saveApiKey()">
              <button onclick="saveApiKey()" class="ai-search-btn" id="ai-key-save-btn"></button>
            </div>
            <p id="ai-key-status" class="text-xs mt-2 hidden"></p>
          </div>
        </div>

        <!-- AI Answer -->
        <div id="ai-answer-panel" class="ai-answer-panel p-6 mb-6 hidden">
          <div class="flex items-center gap-2.5 mb-4">
            <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
              </svg>
            </div>
            <span class="text-sm font-semibold text-white">InsightRadar AI</span>
          </div>
          <div id="ai-answer-content" class="text-sm leading-relaxed"></div>
        </div>

        <!-- Sources -->
        <div id="ai-sources-section" class="hidden">
          <h4 id="ai-sources-label" class="text-xs font-semibold text-stone-500 uppercase tracking-wider mb-3"></h4>
          <div id="ai-sources-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ Feed View ============ -->
  <div id="view-feed" class="view hidden">
    <div class="max-w-[1400px] mx-auto px-4 lg:px-6 py-5 flex gap-6 relative z-10">

      <!-- Sidebar (desktop) -->
      <aside class="sidebar w-56 shrink-0 sticky top-[72px] self-start hidden lg:block" style="max-height: calc(100vh - 88px); overflow-y: auto;">
        <!-- KPI Stats -->
        <div class="mb-5">
          <div class="grid grid-cols-1 gap-2">
            <div class="kpi-card px-3.5 py-3">
              <div class="text-[10px] font-medium text-stone-500 uppercase tracking-wider mb-1" id="kpi-label-raw"></div>
              <div class="kpi-value text-xl font-bold" id="kpi-raw">-</div>
            </div>
            <div class="kpi-card px-3.5 py-3">
              <div class="text-[10px] font-medium text-stone-500 uppercase tracking-wider mb-1" id="kpi-label-clean"></div>
              <div class="kpi-value text-xl font-bold" id="kpi-clean">-</div>
            </div>
            <div class="kpi-card px-3.5 py-3">
              <div class="text-[10px] font-medium text-stone-500 uppercase tracking-wider mb-1" id="kpi-label-classified"></div>
              <div class="kpi-value text-xl font-bold" id="kpi-classified">-</div>
            </div>
          </div>
        </div>

        <!-- Domain Navigation -->
        <div class="mb-4">
          <div class="text-[10px] font-semibold text-stone-500 uppercase tracking-wider px-3 mb-2" id="sidebar-domain-label"></div>
          <nav id="sidebar-domains" class="flex flex-col gap-0.5">
            <!-- filled by JS -->
          </nav>
        </div>
      </aside>

      <!-- Content Area -->
      <main class="flex-1 min-w-0">
        <!-- Mobile Domain Bar -->
        <div class="mobile-domain-bar hidden overflow-x-auto gap-2 mb-4 pb-2" id="mobile-domain-filters" style="scrollbar-width: thin; scrollbar-color: #1e293b transparent;">
          <!-- filled by JS -->
        </div>

        <!-- Search + Sort Bar -->
        <div class="glass-light rounded-2xl p-3 mb-5 flex flex-col sm:flex-row gap-3">
          <div class="relative flex-1">
            <svg class="absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input id="search-input" type="text"
                   class="w-full pl-10 pr-4 py-2.5 bg-stone-900/50 border border-white/[.06] rounded-xl text-sm text-stone-200 placeholder-stone-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/30 transition-all">
          </div>
          <select id="sort-select"
                  class="bg-stone-900/50 border border-white/[.06] rounded-xl px-4 py-2.5 text-sm text-stone-300 focus:outline-none focus:border-amber-500/50 appearance-none cursor-pointer min-w-[160px]">
          </select>
        </div>

        <!-- Item Count -->
        <div class="flex items-center justify-between mb-4 px-1">
          <p id="item-count" class="text-xs text-stone-500 font-medium"></p>
        </div>

        <!-- Items Grid -->
        <div id="items-grid" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
          <div class="skeleton h-52"></div>
          <div class="skeleton h-52"></div>
          <div class="skeleton h-52"></div>
          <div class="skeleton h-52"></div>
          <div class="skeleton h-52"></div>
          <div class="skeleton h-52"></div>
        </div>

        <!-- Load More -->
        <div id="load-more-container" class="hidden text-center py-8">
          <p id="shown-count" class="text-xs text-stone-500 mb-3"></p>
          <button id="load-more-btn" onclick="loadMore()" class="btn-ghost px-8 py-2.5 text-sm font-medium"></button>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-stone-800/50 flex items-center justify-center">
            <svg class="w-8 h-8 text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <p id="empty-title" class="text-stone-400 text-base font-medium"></p>
          <p id="empty-sub" class="text-stone-600 text-sm mt-1"></p>
        </div>
      </main>
    </div>
  </div>

  <!-- AI Analyze Slide Panel Overlay -->
  <div id="ai-analyze-overlay">
    <div class="overlay-bg" onclick="closeAnalyzePanel()"></div>
    <div id="ai-analyze-panel">
      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-white/[.06]">
        <div class="flex items-center gap-2.5">
          <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/>
            </svg>
          </div>
          <span id="analyze-panel-title" class="text-sm font-semibold text-white"></span>
        </div>
        <button onclick="closeAnalyzePanel()" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/[.06] text-stone-400 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <!-- Article info -->
      <div id="analyze-article-info" class="px-5 py-3 border-b border-white/[.04]"></div>
      <!-- Content -->
      <div id="ai-analyze-panel-content" class="flex-1 overflow-y-auto px-5 py-4">
        <div id="analyze-loading" class="text-center py-12">
          <div class="ai-loading-dots mb-3"><span></span><span></span><span></span></div>
          <p id="analyze-loading-text" class="text-sm text-stone-500"></p>
        </div>
        <div id="analyze-result" class="hidden"></div>
        <div id="analyze-error" class="hidden text-center py-12">
          <p id="analyze-error-text" class="text-sm text-red-300"></p>
        </div>
        <div id="analyze-key-setup" class="hidden">
          <div class="ai-answer-panel p-6">
            <div class="flex items-center gap-2.5 mb-4">
              <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/>
                </svg>
              </div>
              <span id="analyze-key-title" class="text-sm font-semibold text-white"></span>
            </div>
            <p id="analyze-key-desc" class="text-xs text-stone-400 mb-4"></p>
            <div class="flex gap-2">
              <input id="analyze-key-input" type="password"
                     class="flex-1 px-4 py-2.5 bg-stone-900/50 border border-white/[.06] rounded-xl text-sm text-stone-200 placeholder-stone-500 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/30 transition-all"
                     onkeydown="if(event.key==='Enter')saveApiKeyFromPanel()">
              <button onclick="saveApiKeyFromPanel()" class="ai-search-btn" id="analyze-key-save-btn"></button>
            </div>
            <p id="analyze-key-status" class="text-xs mt-2 hidden"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== i18n ==========
    const I18N = {
      zh: {
        subtitle: '全球创新与开源情报',
        searchPlaceholder: '搜索标题、描述、标签...',
        sortHeat: '热度指数',
        sortStars: 'Stars',
        sortComments: '评论数',
        sortRecent: '最新发布',
        allDomain: '全部',
        itemCount: (n) => `共 ${n} 条情报`,
        shownCount: (shown, total) => `已加载 ${shown} / ${total}`,
        loadMore: '加载更多',
        emptyTitle: '未找到相关内容',
        emptySub: '尝试调整筛选条件或搜索关键词',
        statsRaw: '原始采集',
        statsClean: '清洗数据',
        statsClassified: '分类数据',
        refreshBtn: '刷新',
        refreshing: '采集中...',
        refreshDone: '采集完成',
        refreshError: '采集失败',
        translateBtn: '翻译',
        translateOn: '翻译中',
        translateOff: '翻译',
        expand: '展开详情',
        collapse: '收起',
        domainLabel: '领域分类',
        domainNames: {
          'AI/ML': '人工智能', 'DevTools': '开发工具', 'Hardware': '硬件',
          'Cloud': '云计算', 'Security': '安全', 'Web': 'Web 开发',
          'Mobile': '移动端', 'Data': '数据', 'Blockchain': '区块链',
          'Biotech': '生物科技', 'Other': '其他',
        },
        sourceNames: { 'github': 'GitHub', 'hackernews': 'HN', 'rss': 'RSS' },
        stars: 'Stars',
        comments: '评论',
        timeAgo: { s: '秒前', m: '分钟前', h: '小时前', d: '天前' },
        // AI Search
        tabAISearch: 'AI 搜索',
        tabFeed: '信息流',
        aiGreeting: '今天想了解什么？',
        aiSubtitle: '询问今天的科技新闻和开源动态',
        aiSearchPlaceholder: '例如：AI coding 最新动态、安全漏洞、开源项目...',
        aiSearchBtn: '搜索',
        aiSearching: '正在分析相关情报...',
        aiSourcesLabel: '引用来源',
        aiQueryLabel: '搜索：',
        aiNewSearch: '新搜索',
        aiSuggestions: ['AI coding', '安全漏洞', '开源项目', 'DevTools 趋势', '云计算动态'],
        aiKeyTitle: '配置 AI 搜索',
        aiKeyDesc: '请输入 ZhipuAI API Key 以启用 AI 搜索功能。可从 open.bigmodel.cn 获取。',
        aiKeySaveBtn: '保存',
        aiKeyPlaceholder: '输入 API Key...',
        aiKeySaved: 'API Key 已保存',
        aiKeySaveError: '保存失败',
        aiAnalyzeBtn: 'AI 解读',
        aiAnalyzeTitle: 'AI 深度解读',
        aiAnalyzing: '正在分析文章...',
        aiLatestBtn: '最新热点',
        aiLatestQuery: '今日最热科技新闻与开源动态',
      },
      en: {
        subtitle: 'Global Innovation Intelligence',
        searchPlaceholder: 'Search titles, descriptions, tags...',
        sortHeat: 'Heat Index',
        sortStars: 'Stars',
        sortComments: 'Comments',
        sortRecent: 'Most Recent',
        allDomain: 'All',
        itemCount: (n) => `${n} items`,
        shownCount: (shown, total) => `Loaded ${shown} of ${total}`,
        loadMore: 'Load More',
        emptyTitle: 'No items found',
        emptySub: 'Try adjusting your filters or search query',
        statsRaw: 'Raw',
        statsClean: 'Cleaned',
        statsClassified: 'Classified',
        refreshBtn: 'Refresh',
        refreshing: 'Collecting...',
        refreshDone: 'Done',
        refreshError: 'Failed',
        translateBtn: 'Transtone',
        translateOn: 'Translating',
        translateOff: 'Transtone',
        expand: 'Details',
        collapse: 'Collapse',
        domainLabel: 'Domains',
        domainNames: {
          'AI/ML': 'AI / ML', 'DevTools': 'DevTools', 'Hardware': 'Hardware',
          'Cloud': 'Cloud', 'Security': 'Security', 'Web': 'Web',
          'Mobile': 'Mobile', 'Data': 'Data', 'Blockchain': 'Blockchain',
          'Biotech': 'Biotech', 'Other': 'Other',
        },
        sourceNames: { 'github': 'GitHub', 'hackernews': 'HN', 'rss': 'RSS' },
        stars: 'Stars',
        comments: 'Comments',
        timeAgo: { s: 's ago', m: 'm ago', h: 'h ago', d: 'd ago' },
        // AI Search
        tabAISearch: 'AI Search',
        tabFeed: 'Feed',
        aiGreeting: 'What do you want to know?',
        aiSubtitle: 'Ask about today\'s tech news and open source trends',
        aiSearchPlaceholder: 'e.g., AI coding trends, security vulnerabilities, open source...',
        aiSearchBtn: 'Search',
        aiSearching: 'Analyzing relevant intelligence...',
        aiSourcesLabel: 'Sources',
        aiQueryLabel: 'Search:',
        aiNewSearch: 'New search',
        aiSuggestions: ['AI coding', 'Security', 'Open source', 'DevTools trends', 'Cloud updates'],
        aiKeyTitle: 'Configure AI Search',
        aiKeyDesc: 'Enter your ZhipuAI API Key to enable AI search. Get one at open.bigmodel.cn.',
        aiKeySaveBtn: 'Save',
        aiKeyPlaceholder: 'Enter API Key...',
        aiKeySaved: 'API Key saved',
        aiKeySaveError: 'Save failed',
        aiAnalyzeBtn: 'AI Analysis',
        aiAnalyzeTitle: 'AI Deep Analysis',
        aiAnalyzing: 'Analyzing article...',
        aiLatestBtn: 'Trending',
        aiLatestQuery: "Today's hottest tech news and open source trends",
      },
    };

    let lang = localStorage.getItem('ir-lang') || 'zh';
    let currentView = 'ai-search';
    function t() { return I18N[lang]; }

    // ========== View Switching ==========
    function switchView(view) {
      currentView = view;
      document.getElementById('view-ai-search').classList.toggle('hidden', view !== 'ai-search');
      document.getElementById('view-feed').classList.toggle('hidden', view !== 'feed');

      // Tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });

      // Feed-only buttons
      document.querySelectorAll('.feed-only-btn').forEach(btn => {
        btn.classList.toggle('hidden', view !== 'feed');
      });

      // Load feed data on first switch
      if (view === 'feed' && !feedLoaded) {
        feedLoaded = true;
        loadDomains();
        loadItems(false);
        loadStats();
      }
    }

    let feedLoaded = false;

    function setLang(l) {
      lang = l;
      localStorage.setItem('ir-lang', l);
      document.documentElement.lang = l === 'zh' ? 'zh-CN' : 'en';
      applyLang();
      if (feedLoaded) {
        loadDomains();
        resetAndLoadItems();
        loadStats();
      }
    }

    function applyLang() {
      const s = t();
      document.getElementById('subtitle').textContent = s.subtitle;
      document.getElementById('search-input').placeholder = s.searchPlaceholder;
      document.getElementById('empty-title').textContent = s.emptyTitle;
      document.getElementById('empty-sub').textContent = s.emptySub;
      document.getElementById('refresh-text').textContent = s.refreshBtn;
      document.getElementById('translate-text').textContent = translateMode ? s.translateOn : s.translateBtn;
      document.getElementById('load-more-btn').textContent = s.loadMore;
      document.getElementById('sidebar-domain-label').textContent = s.domainLabel;

      // KPI labels
      document.getElementById('kpi-label-raw').textContent = s.statsRaw;
      document.getElementById('kpi-label-clean').textContent = s.statsClean;
      document.getElementById('kpi-label-classified').textContent = s.statsClassified;

      const sel = document.getElementById('sort-select');
      const curVal = sel.value || 'heat';
      sel.innerHTML = `
        <option value="heat">${s.sortHeat}</option>
        <option value="stars">${s.sortStars}</option>
        <option value="comments">${s.sortComments}</option>
        <option value="recent">${s.sortRecent}</option>
      `;
      sel.value = curVal;

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Tab labels
      document.getElementById('tab-ai-search-text').textContent = s.tabAISearch;
      document.getElementById('tab-feed-text').textContent = s.tabFeed;

      // AI Search labels
      document.getElementById('ai-greeting').textContent = s.aiGreeting;
      document.getElementById('ai-subtitle-text').textContent = s.aiSubtitle;
      document.getElementById('ai-search-input').placeholder = s.aiSearchPlaceholder;
      document.getElementById('ai-search-btn').textContent = s.aiSearchBtn;
      document.getElementById('ai-loading-text').textContent = s.aiSearching;
      document.getElementById('ai-sources-label').textContent = s.aiSourcesLabel;
      document.getElementById('ai-query-label').textContent = s.aiQueryLabel;
      document.getElementById('ai-new-search-btn').textContent = s.aiNewSearch;

      // API Key setup labels
      document.getElementById('ai-key-title').textContent = s.aiKeyTitle;
      document.getElementById('ai-key-desc').textContent = s.aiKeyDesc;
      document.getElementById('ai-key-save-btn').textContent = s.aiKeySaveBtn;
      document.getElementById('ai-key-input').placeholder = s.aiKeyPlaceholder;

      // AI Analyze panel labels
      document.getElementById('analyze-panel-title').textContent = s.aiAnalyzeTitle;
      document.getElementById('analyze-loading-text').textContent = s.aiAnalyzing;
      document.getElementById('analyze-key-title').textContent = s.aiKeyTitle;
      document.getElementById('analyze-key-desc').textContent = s.aiKeyDesc;
      document.getElementById('analyze-key-save-btn').textContent = s.aiKeySaveBtn;
      document.getElementById('analyze-key-input').placeholder = s.aiKeyPlaceholder;

      // Lightning button
      document.getElementById('ai-latest-btn-text').textContent = s.aiLatestBtn;

      // Render suggestions
      const sugContainer = document.getElementById('ai-suggestions');
      sugContainer.innerHTML = s.aiSuggestions.map(sug =>
        `<button class="suggestion-chip" onclick="doAISearch('${sug}')">${sug}</button>`
      ).join('');
    }

    // ========== Config ==========
    const DOMAIN_ICONS = {
      'AI/ML': '&#x1F916;', 'DevTools': '&#x1F6E0;', 'Hardware': '&#x1F4BB;',
      'Cloud': '&#x2601;', 'Security': '&#x1F512;', 'Web': '&#x1F310;',
      'Mobile': '&#x1F4F1;', 'Data': '&#x1F4CA;', 'Blockchain': '&#x26D3;',
      'Biotech': '&#x1F9EC;', 'Other': '&#x1F4E6;',
    };

    const DOMAIN_COLORS = {
      'AI/ML': { bg: 'rgba(217,119,6,.12)', text: '#fbbf24', border: 'rgba(217,119,6,.3)', accent: '#d97706' },
      'DevTools': { bg: 'rgba(45,212,191,.1)', text: '#5eead4', border: 'rgba(45,212,191,.25)', accent: '#2dd4bf' },
      'Hardware': { bg: 'rgba(239,68,68,.1)', text: '#fca5a5', border: 'rgba(239,68,68,.2)', accent: '#ef4444' },
      'Cloud': { bg: 'rgba(96,165,250,.1)', text: '#93c5fd', border: 'rgba(96,165,250,.25)', accent: '#60a5fa' },
      'Security': { bg: 'rgba(250,204,21,.1)', text: '#fde047', border: 'rgba(250,204,21,.2)', accent: '#facc15' },
      'Web': { bg: 'rgba(168,162,150,.1)', text: '#d6d3d1', border: 'rgba(168,162,150,.2)', accent: '#a8a29e' },
      'Mobile': { bg: 'rgba(251,146,60,.1)', text: '#fdba74', border: 'rgba(251,146,60,.25)', accent: '#fb923c' },
      'Data': { bg: 'rgba(74,222,128,.1)', text: '#86efac', border: 'rgba(74,222,128,.25)', accent: '#4ade80' },
      'Blockchain': { bg: 'rgba(180,83,9,.12)', text: '#f59e0b', border: 'rgba(180,83,9,.25)', accent: '#b45309' },
      'Biotech': { bg: 'rgba(232,121,249,.1)', text: '#f0abfc', border: 'rgba(232,121,249,.25)', accent: '#e879f9' },
      'Other': { bg: 'rgba(168,162,150,.08)', text: '#a8a29e', border: 'rgba(168,162,150,.15)', accent: '#a8a29e' },
    };

    const SOURCE_STYLES = {
      'github': { bg: 'rgba(110,118,129,.15)', text: '#c9d1d9', label: 'GitHub' },
      'hackernews': { bg: 'rgba(255,102,0,.12)', text: '#ff8c40', label: 'HN' },
      'rss': { bg: 'rgba(74,222,128,.1)', text: '#86efac', label: 'RSS' },
      'web_search': { bg: 'rgba(59,130,246,.12)', text: '#60a5fa', label: 'Web' },
    };

    let currentDomain = 'All';
    let currentSearch = '';
    let currentSort = 'heat';
    let debounceTimer = null;
    const PAGE_SIZE = 20;
    let currentOffset = 0;
    let totalItems = 0;
    let translateMode = false;
    const translationCache = {};
    let aiSearchAbort = null;
    let analyzeAbort = null;
    const itemDataCache = {};

    // ========== Toast ==========
    function showToast(msg, type = 'info') {
      const container = document.getElementById('toast-container');
      const colors = {
        info: 'glass text-stone-300',
        success: 'bg-emerald-900/80 border border-emerald-700/50 text-emerald-200',
        error: 'bg-red-900/80 border border-red-700/50 text-red-200',
      };
      const el = document.createElement('div');
      el.className = `toast-enter px-4 py-3 rounded-xl text-sm font-medium ${colors[type] || colors.info}`;
      el.textContent = msg;
      container.appendChild(el);
      setTimeout(() => {
        el.classList.remove('toast-enter');
        el.classList.add('toast-exit');
        setTimeout(() => el.remove(), 300);
      }, 4000);
    }

    // ========== Time ==========
    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const diff = Math.floor((new Date() - new Date(dateStr)) / 1000);
      const u = t().timeAgo;
      if (diff < 60) return diff + u.s;
      if (diff < 3600) return Math.floor(diff / 60) + u.m;
      if (diff < 86400) return Math.floor(diff / 3600) + u.h;
      return Math.floor(diff / 86400) + u.d;
    }

    // ========== Heat ==========
    function getHeatColor(heat) {
      if (heat >= 70) return '#ef4444';
      if (heat >= 50) return '#d97706';
      if (heat >= 30) return '#b08d57';
      return '#78716c';
    }

    function getHeatGradient(heat) {
      if (heat >= 70) return 'linear-gradient(90deg, #ef4444, #f97316)';
      if (heat >= 50) return 'linear-gradient(90deg, #d97706, #fbbf24)';
      if (heat >= 30) return 'linear-gradient(90deg, #b08d57, #c9a04e)';
      return 'linear-gradient(90deg, #78716c, #a8a29e)';
    }

    function domainLabel(key) { return t().domainNames[key] || key; }
    function sourceLabel(key) { return t().sourceNames[key] || key; }

    // ========== Card Render ==========
    function renderCard(item) {
      const cacheKey = 'item-' + item.id;
      itemDataCache[cacheKey] = item;

      const dc = DOMAIN_COLORS[item.domain] || DOMAIN_COLORS['Other'];
      const heatColor = getHeatColor(item.heat_index);
      const heatGrad = getHeatGradient(item.heat_index);
      const isHot = item.heat_index >= 70;

      const badges = item.sources.map(s => {
        const st = SOURCE_STYLES[s] || SOURCE_STYLES['rss'];
        return `<span class="source-badge" style="background:${st.bg};color:${st.text}">${sourceLabel(s)}</span>`;
      }).join('');

      const tags = (item.tags || []).slice(0, 5).map(tag =>
        `<span class="tag-pill">${tag}</span>`
      ).join('');

      const desc = item.description
        ? (item.description.length > 160 ? item.description.substring(0, 160) + '...' : item.description)
        : '';

      const ago = timeAgo(item.published_at);
      const detailId = 'detail-' + item.id;
      const hasDetails = tags || item.heat_reason;

      return `
        <div class="card p-5 fade-in ${isHot ? 'card-hot' : ''}">
          <!-- Top row: domain + heat -->
          <div class="flex items-center justify-between mb-3">
            <span class="text-[11px] font-semibold px-2.5 py-1 rounded-lg" style="background:${dc.bg};color:${dc.text};border:1px solid ${dc.border}">${domainLabel(item.domain)}</span>
            <div class="flex items-center gap-1.5">
              <div class="w-2 h-2 rounded-full" style="background:${heatColor};${isHot ? 'box-shadow:0 0 8px ' + heatColor : ''}"></div>
              <span class="text-sm font-bold tabular-nums" style="color:${heatColor}">${item.heat_index}</span>
            </div>
          </div>

          <!-- Title -->
          <a href="${item.url}" target="_blank" rel="noopener"
             class="card-title block text-[13px] font-semibold text-stone-100 mb-2 leading-snug hover:text-amber-400 transition-colors line-clamp-2"
             data-original="${item.title.replace(/"/g, '&quot;')}">${item.title}</a>

          <!-- Description -->
          ${desc ? `<p class="card-desc text-xs text-stone-400 mb-3 leading-relaxed line-clamp-3" data-original="${desc.replace(/"/g, '&quot;')}">${desc}</p>` : '<div class="mb-3"></div>'}

          <!-- Heat bar -->
          <div class="heat-bar-bg w-full mb-3">
            <div class="heat-bar-fill" style="width:${Math.min(item.heat_index, 100)}%;background:${heatGrad}"></div>
          </div>

          <!-- Footer -->
          <div class="flex items-center justify-between text-[11px]">
            <div class="flex items-center gap-2">
              ${badges}
              ${ago ? `<span class="text-stone-500">${ago}</span>` : ''}
              <button class="btn-ai-analyze" onclick="event.stopPropagation();openAnalyzePanel(itemDataCache['${cacheKey}'])">
                <svg class="w-3 h-3 inline -mt-px mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
                ${t().aiAnalyzeBtn}
              </button>
            </div>
            <div class="flex items-center gap-3 text-stone-500">
              ${item.stars > 0 ? `<span class="flex items-center gap-1" title="${t().stars}"><svg class="w-3 h-3 text-yellow-500/70" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>${item.stars.toLocaleString()}</span>` : ''}
              ${item.comments_count > 0 ? `<span class="flex items-center gap-1" title="${t().comments}"><svg class="w-3 h-3 text-blue-400/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>${item.comments_count}</span>` : ''}
              ${item.language ? `<span>${item.language}</span>` : ''}
            </div>
          </div>

          <!-- Expandable details -->
          ${hasDetails ? `
          <div class="mt-3 pt-3 border-t border-white/[.04]">
            <button class="details-toggle text-[11px] text-amber-400/80 hover:text-amber-300 font-medium transition-colors" onclick="toggleDetails('${detailId}', this)">${t().expand}</button>
            <div id="${detailId}" class="details-content mt-2">
              ${tags ? `<div class="flex flex-wrap gap-1.5 mb-2">${tags}</div>` : ''}
              ${item.heat_reason ? `<p class="text-[11px] text-stone-500 italic leading-relaxed">${item.heat_reason}</p>` : ''}
            </div>
          </div>` : ''}
        </div>
      `;
    }

    function toggleDetails(id, btn) {
      const el = document.getElementById(id);
      const isOpen = el.classList.toggle('open');
      btn.textContent = isOpen ? t().collapse : t().expand;
    }

    // ========== Refresh ==========
    async function doRefresh() {
      const btn = document.getElementById('refresh-btn');
      const icon = document.getElementById('refresh-icon');
      const text = document.getElementById('refresh-text');
      btn.disabled = true;
      btn.style.opacity = '.5';
      icon.classList.add('spin');
      text.textContent = t().refreshing;

      try {
        const resp = await fetch('/api/collect', { method: 'POST' });
        const data = await resp.json();
        if (data.status === 'ok') {
          showToast(`${t().refreshDone}: ${data.stats?.new || 0} new`, 'success');
          resetAndLoadItems();
          loadDomains();
          loadStats();
        } else if (data.status === 'busy') {
          showToast(data.message, 'info');
        } else {
          showToast(`${t().refreshError}: ${data.message}`, 'error');
        }
      } catch (e) {
        showToast(`${t().refreshError}: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
        icon.classList.remove('spin');
        text.textContent = t().refreshBtn;
      }
    }

    // ========== Translation ==========
    async function translateText(text) {
      if (!text || text.trim() === '') return text;
      const key = text.substring(0, 100);
      if (translationCache[key]) return translationCache[key];
      try {
        const resp = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text, target: 'zh' }),
        });
        const data = await resp.json();
        if (data.translated) {
          translationCache[key] = data.translated;
          return data.translated;
        }
      } catch (e) {}
      return text;
    }

    async function translateVisibleCards() {
      for (const el of document.querySelectorAll('.card-title')) {
        const original = el.dataset.original || el.textContent;
        el.dataset.original = original;
        el.textContent = await translateText(original);
      }
      for (const el of document.querySelectorAll('.card-desc')) {
        const original = el.dataset.original || el.textContent;
        el.dataset.original = original;
        el.textContent = await translateText(original);
      }
    }

    function restoreOriginalText() {
      document.querySelectorAll('.card-title').forEach(el => {
        if (el.dataset.original) el.textContent = el.dataset.original;
      });
      document.querySelectorAll('.card-desc').forEach(el => {
        if (el.dataset.original) el.textContent = el.dataset.original;
      });
    }

    async function toggleTranstone() {
      translateMode = !translateMode;
      const btn = document.getElementById('translate-btn');
      const text = document.getElementById('translate-text');
      if (translateMode) {
        btn.classList.add('active');
        text.textContent = t().translateOn;
        await translateVisibleCards();
      } else {
        btn.classList.remove('active');
        text.textContent = t().translateBtn;
        restoreOriginalText();
      }
    }

    // ========== AI Search ==========
    let aiSources = [];

    function resetAISearch() {
      document.getElementById('ai-hero').classList.remove('hidden');
      document.getElementById('ai-suggestions').classList.remove('hidden');
      document.getElementById('ai-result-area').classList.add('hidden');
      document.getElementById('ai-loading').classList.add('hidden');
      document.getElementById('ai-error').classList.add('hidden');
      document.getElementById('ai-key-setup').classList.add('hidden');
      document.getElementById('ai-answer-panel').classList.add('hidden');
      document.getElementById('ai-sources-section').classList.add('hidden');
      document.getElementById('ai-search-input').value = '';
      document.getElementById('ai-search-btn').disabled = false;
      document.getElementById('ai-latest-btn').disabled = false;
      document.getElementById('ai-answer-content').innerHTML = '';
      aiSources = [];
      if (aiSearchAbort) { aiSearchAbort.abort(); aiSearchAbort = null; }
    }

    async function doAISearch(query) {
      if (!query) query = document.getElementById('ai-search-input').value.trim();
      if (!query) return;

      // Abort previous
      if (aiSearchAbort) { aiSearchAbort.abort(); aiSearchAbort = null; }

      document.getElementById('ai-search-input').value = query;
      document.getElementById('ai-hero').classList.add('hidden');
      document.getElementById('ai-suggestions').classList.add('hidden');
      document.getElementById('ai-result-area').classList.remove('hidden');
      document.getElementById('ai-query-text').textContent = query;
      document.getElementById('ai-loading').classList.remove('hidden');
      document.getElementById('ai-error').classList.add('hidden');
      document.getElementById('ai-key-setup').classList.add('hidden');
      document.getElementById('ai-answer-panel').classList.add('hidden');
      document.getElementById('ai-sources-section').classList.add('hidden');
      document.getElementById('ai-answer-content').innerHTML = '';
      document.getElementById('ai-search-btn').disabled = true;
      document.getElementById('ai-latest-btn').disabled = true;
      aiSources = [];

      const controller = new AbortController();
      aiSearchAbort = controller;
      let fullText = '';

      try {
        const resp = await fetch('/api/ai-search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query }),
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: (sources) => {
            aiSources = sources;
            renderAISources(aiSources);
          },
          onWebSources: (webSources) => {
            _mergeWebSources(webSources);
            renderAISources(aiSources);
          },
          onChunk: (text) => {
            fullText += text;
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-answer-panel').classList.remove('hidden');
            renderStreamingMarkdown(fullText);
          },
          onDone: () => {
            renderFinalMarkdown(fullText);
          },
          onError: (msg) => {
            showAIError(msg);
          },
        });

        if (fullText) renderFinalMarkdown(fullText);

      } catch (e) {
        if (e.name !== 'AbortError') {
          showAIError(e.message);
        }
      } finally {
        document.getElementById('ai-search-btn').disabled = false;
        document.getElementById('ai-latest-btn').disabled = false;
        document.getElementById('ai-loading').classList.add('hidden');
        aiSearchAbort = null;
      }
    }

    function showAIError(msg) {
      document.getElementById('ai-loading').classList.add('hidden');
      if (msg === 'needsApiKey') {
        // Show API key setup panel instead of generic error
        document.getElementById('ai-error').classList.add('hidden');
        document.getElementById('ai-key-setup').classList.remove('hidden');
        return;
      }
      document.getElementById('ai-key-setup').classList.add('hidden');
      document.getElementById('ai-error').classList.remove('hidden');
      document.getElementById('ai-error-text').textContent = msg;
    }

    async function saveApiKey() {
      const input = document.getElementById('ai-key-input');
      const status = document.getElementById('ai-key-status');
      const key = input.value.trim();
      if (!key) return;

      try {
        const resp = await fetch('/api/ai-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key }),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          status.textContent = t().aiKeySaved;
          status.className = 'text-xs mt-2 text-emerald-400';
          status.classList.remove('hidden');
          // Re-run the previous search after a short delay
          setTimeout(() => {
            document.getElementById('ai-key-setup').classList.add('hidden');
            status.classList.add('hidden');
            const query = document.getElementById('ai-search-input').value.trim();
            if (query) doAISearch(query);
          }, 800);
        } else {
          status.textContent = data.message || t().aiKeySaveError;
          status.className = 'text-xs mt-2 text-red-400';
          status.classList.remove('hidden');
        }
      } catch (e) {
        status.textContent = t().aiKeySaveError + ': ' + e.message;
        status.className = 'text-xs mt-2 text-red-400';
        status.classList.remove('hidden');
      }
    }

    function _mergeWebSources(webSources) {
      // Append web sources after local sources as supplementary results.
      // GLM's refer field is just a sequential ID, not a citation number mapping.
      webSources.forEach(ws => {
        ws._isWebSource = true;
        aiSources.push(ws);
      });
    }

    function renderAISources(sources) {
      if (!sources.length) return;
      const grid = document.getElementById('ai-sources-grid');
      const section = document.getElementById('ai-sources-section');
      section.classList.remove('hidden');

      const firstWebIdx = sources.findIndex(s => s._isWebSource || (s.sources && s.sources.includes('web_search')));

      grid.innerHTML = sources.map((item, i) => {
        const cacheKey = 'aisrc-' + i;
        itemDataCache[cacheKey] = item;
        const isWeb = item._isWebSource || (item.sources && item.sources.includes('web_search'));
        const dc = DOMAIN_COLORS[item.domain] || DOMAIN_COLORS['Other'];
        const heatColor = getHeatColor(item.heat_index);
        const srcBadges = (item.sources || []).map(s => {
          const st = SOURCE_STYLES[s] || SOURCE_STYLES['rss'];
          return `<span class="source-badge" style="background:${st.bg};color:${st.text}">${st.label}</span>`;
        }).join('');

        const clickAction = item.url ? `onclick="window.open('${item.url}','_blank')"` : '';
        const divider = (i === firstWebIdx && firstWebIdx > 0) ? `<div style="grid-column:1/-1;display:flex;align-items:center;gap:8px;padding:4px 0"><div style="flex:1;height:1px;background:rgba(59,130,246,.25)"></div><span style="font-size:10px;color:#60a5fa;white-space:nowrap">${lang === 'zh' ? '🌐 联网补充' : '🌐 Web Results'}</span><div style="flex:1;height:1px;background:rgba(59,130,246,.25)"></div></div>` : '';
        return divider + `
          <div class="ai-source-card${isWeb ? ' web-source' : ''}" id="ai-source-${i + 1}" ${clickAction} style="${item.url ? 'cursor:pointer' : 'cursor:default'}">
            <div class="flex items-center gap-2 mb-2">
              <span class="text-xs font-bold text-amber-400 bg-amber-500/10 px-1.5 py-0.5 rounded">[${i + 1}]</span>
              <span class="text-[10px] font-semibold px-2 py-0.5 rounded" style="background:${dc.bg};color:${dc.text}">${item.domain}</span>
              <span class="text-xs font-bold ml-auto" style="color:${heatColor}">${item.heat_index}</span>
            </div>
            <p class="text-xs font-semibold text-stone-200 leading-snug mb-1.5 line-clamp-2">${item.title}</p>
            <div class="flex items-center justify-between text-[10px]">
              <div class="flex items-center gap-2">
                ${srcBadges}
                ${item.stars > 0 ? `<span class="text-stone-500">${item.stars} stars</span>` : ''}
                ${item.comments_count > 0 ? `<span class="text-stone-500">${item.comments_count} comments</span>` : ''}
              </div>
              <button class="btn-ai-analyze" onclick="event.stopPropagation();openAnalyzePanel(itemDataCache['${cacheKey}'])">
                <svg class="w-3 h-3 inline -mt-px mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
                ${t().aiAnalyzeBtn}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ========== Markdown Rendering ==========
    function renderMarkdown(text) {
      let html = text
        // Escape HTML
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        // Headers
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        // Bold
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // Links [text](url)
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
        // Citations [N] — with tooltip showing source title
        .replace(/\[(\d+)\]/g, (match, num) => {
          const idx = parseInt(num, 10) - 1;
          const src = (typeof aiSources !== 'undefined' && aiSources[idx]) ? aiSources[idx] : null;
          const tip = src ? src.title.replace(/"/g, '&quot;').substring(0, 60) : '';
          return `<span class="citation" onclick="scrollToSource(${num})" title="${tip}">${num}</span>`;
        })
        // List items
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        // Wrap consecutive <li> in <ul>
        .replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>')
        // Paragraphs (double newline)
        .replace(/\n\n/g, '</p><p>')
        // Single newlines within paragraphs
        .replace(/\n/g, '<br>');

      // Wrap in <p> if not starting with block element
      if (!html.startsWith('<h3>') && !html.startsWith('<ul>')) {
        html = '<p>' + html + '</p>';
      }

      // Clean up empty <p> tags
      html = html.replace(/<p><\/p>/g, '').replace(/<p>(<h3>)/g, '$1').replace(/(<\/h3>)<\/p>/g, '$1');

      return html;
    }

    function renderStreamingMarkdown(text) {
      const content = document.getElementById('ai-answer-content');
      content.innerHTML = renderMarkdown(text) + '<span class="streaming-cursor"></span>';
      content.scrollTop = content.scrollHeight;
    }

    function renderFinalMarkdown(text) {
      const content = document.getElementById('ai-answer-content');
      content.innerHTML = renderMarkdown(text);
    }

    function scrollToSource(n) {
      const card = document.getElementById(`ai-source-${n}`);
      if (!card) return;
      card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      card.classList.add('highlight');
      setTimeout(() => card.classList.remove('highlight'), 2000);
    }

    // ========== Shared SSE Processing ==========
    async function _processSSE(response, { onSources, onChunk, onDone, onError, onWebSources }) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let eventType = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          if (line.startsWith('event: ')) {
            eventType = line.slice(7).trim();
            continue;
          }
          if (line.startsWith('data: ')) {
            const dataStr = line.slice(6);

            if (eventType === 'sources') {
              try { onSources(JSON.parse(dataStr)); } catch (e) {}
              eventType = '';
              continue;
            }
            if (eventType === 'web_sources') {
              try { if (onWebSources) onWebSources(JSON.parse(dataStr)); } catch (e) {}
              eventType = '';
              continue;
            }
            if (eventType === 'error') {
              try { onError(JSON.parse(dataStr).error || dataStr); } catch (e) { onError(dataStr); }
              eventType = '';
              continue;
            }
            if (eventType === 'done') {
              onDone();
              eventType = '';
              continue;
            }
            // Text chunk
            try {
              const chunk = JSON.parse(dataStr);
              if (chunk.text) onChunk(chunk.text);
            } catch (e) {}
            eventType = '';
          }
        }
      }
    }

    // ========== AI Analyze Panel ==========
    function openAnalyzePanel(itemData) {
      if (!itemData) return;
      const overlay = document.getElementById('ai-analyze-overlay');
      const infoEl = document.getElementById('analyze-article-info');
      const dc = DOMAIN_COLORS[itemData.domain] || DOMAIN_COLORS['Other'];
      const heatColor = getHeatColor(itemData.heat_index || 0);

      infoEl.innerHTML = `
        <div class="flex items-center gap-2 mb-1.5">
          <span class="text-[10px] font-semibold px-2 py-0.5 rounded" style="background:${dc.bg};color:${dc.text}">${itemData.domain || ''}</span>
          <span class="text-xs font-bold" style="color:${heatColor}">${itemData.heat_index || 0}</span>
        </div>
        <p class="text-sm font-semibold text-stone-100 leading-snug">${itemData.title || ''}</p>
      `;

      document.getElementById('analyze-loading').classList.remove('hidden');
      document.getElementById('analyze-result').classList.add('hidden');
      document.getElementById('analyze-result').innerHTML = '';
      document.getElementById('analyze-error').classList.add('hidden');
      document.getElementById('analyze-key-setup').classList.add('hidden');

      overlay.classList.add('open');
      document.body.style.overflow = 'hidden';

      streamAnalysis(itemData);
    }

    function closeAnalyzePanel() {
      const overlay = document.getElementById('ai-analyze-overlay');
      overlay.classList.remove('open');
      document.body.style.overflow = '';
      if (analyzeAbort) { analyzeAbort.abort(); analyzeAbort = null; }
    }

    async function streamAnalysis(itemData) {
      if (analyzeAbort) { analyzeAbort.abort(); }
      const controller = new AbortController();
      analyzeAbort = controller;
      let fullText = '';

      try {
        const resp = await fetch('/api/ai-analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(itemData),
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: () => {},
          onChunk: (text) => {
            fullText += text;
            document.getElementById('analyze-loading').classList.add('hidden');
            const result = document.getElementById('analyze-result');
            result.classList.remove('hidden');
            result.innerHTML = renderMarkdown(fullText) + '<span class="streaming-cursor"></span>';
            result.scrollTop = result.scrollHeight;
          },
          onDone: () => {
            document.getElementById('analyze-result').innerHTML = renderMarkdown(fullText);
          },
          onError: (msg) => {
            document.getElementById('analyze-loading').classList.add('hidden');
            if (msg === 'needsApiKey') {
              document.getElementById('analyze-key-setup').classList.remove('hidden');
              // Store item for retry after key save
              document.getElementById('analyze-key-setup').dataset.retryItem = JSON.stringify(itemData);
              return;
            }
            document.getElementById('analyze-error').classList.remove('hidden');
            document.getElementById('analyze-error-text').textContent = msg;
          },
        });

        if (fullText) document.getElementById('analyze-result').innerHTML = renderMarkdown(fullText);
      } catch (e) {
        if (e.name !== 'AbortError') {
          document.getElementById('analyze-loading').classList.add('hidden');
          document.getElementById('analyze-error').classList.remove('hidden');
          document.getElementById('analyze-error-text').textContent = e.message;
        }
      } finally {
        document.getElementById('analyze-loading').classList.add('hidden');
        analyzeAbort = null;
      }
    }

    async function saveApiKeyFromPanel() {
      const input = document.getElementById('analyze-key-input');
      const status = document.getElementById('analyze-key-status');
      const key = input.value.trim();
      if (!key) return;

      try {
        const resp = await fetch('/api/ai-config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: key }),
        });
        const data = await resp.json();
        if (data.status === 'ok') {
          status.textContent = t().aiKeySaved;
          status.className = 'text-xs mt-2 text-emerald-400';
          status.classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('analyze-key-setup').classList.add('hidden');
            status.classList.add('hidden');
            // Retry analysis
            const retryStr = document.getElementById('analyze-key-setup').dataset.retryItem;
            if (retryStr) {
              try { streamAnalysis(JSON.parse(retryStr)); } catch (e) {}
            }
          }, 800);
        } else {
          status.textContent = data.message || t().aiKeySaveError;
          status.className = 'text-xs mt-2 text-red-400';
          status.classList.remove('hidden');
        }
      } catch (e) {
        status.textContent = t().aiKeySaveError + ': ' + e.message;
        status.className = 'text-xs mt-2 text-red-400';
        status.classList.remove('hidden');
      }
    }

    // ========== AI Latest (Trending) ==========
    async function doLatestSearch() {
      // Abort previous
      if (aiSearchAbort) { aiSearchAbort.abort(); aiSearchAbort = null; }

      const latestQuery = t().aiLatestQuery;
      document.getElementById('ai-search-input').value = latestQuery;
      document.getElementById('ai-hero').classList.add('hidden');
      document.getElementById('ai-suggestions').classList.add('hidden');
      document.getElementById('ai-result-area').classList.remove('hidden');
      document.getElementById('ai-query-text').textContent = latestQuery;
      document.getElementById('ai-loading').classList.remove('hidden');
      document.getElementById('ai-error').classList.add('hidden');
      document.getElementById('ai-answer-panel').classList.add('hidden');
      document.getElementById('ai-sources-section').classList.add('hidden');
      document.getElementById('ai-answer-content').innerHTML = '';
      document.getElementById('ai-search-btn').disabled = true;
      document.getElementById('ai-latest-btn').disabled = true;
      aiSources = [];

      const controller = new AbortController();
      aiSearchAbort = controller;
      let fullText = '';

      try {
        const resp = await fetch('/api/ai-latest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: '{}',
          signal: controller.signal,
        });

        await _processSSE(resp, {
          onSources: (sources) => {
            aiSources = sources;
            renderAISources(aiSources);
          },
          onWebSources: (webSources) => {
            _mergeWebSources(webSources);
            renderAISources(aiSources);
          },
          onChunk: (text) => {
            fullText += text;
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-answer-panel').classList.remove('hidden');
            renderStreamingMarkdown(fullText);
          },
          onDone: () => {
            renderFinalMarkdown(fullText);
          },
          onError: (msg) => {
            showAIError(msg);
          },
        });

        if (fullText) renderFinalMarkdown(fullText);
      } catch (e) {
        if (e.name !== 'AbortError') {
          showAIError(e.message);
        }
      } finally {
        document.getElementById('ai-search-btn').disabled = false;
        document.getElementById('ai-latest-btn').disabled = false;
        document.getElementById('ai-loading').classList.add('hidden');
        aiSearchAbort = null;
      }
    }

    // ========== Data Loading ==========
    async function loadDomains() {
      const resp = await fetch('/api/domains');
      const domains = await resp.json();

      let total = 0;
      domains.forEach(d => total += d.count);

      // Sidebar domains (desktop)
      const sidebar = document.getElementById('sidebar-domains');
      let sidebarHtml = `<div class="domain-item ${currentDomain === 'All' ? 'active' : ''}" data-domain="All">
        <span>${t().allDomain}</span><span class="count">${total}</span>
      </div>`;
      for (const d of domains) {
        const icon = DOMAIN_ICONS[d.domain] || '';
        sidebarHtml += `<div class="domain-item ${currentDomain === d.domain ? 'active' : ''}" data-domain="${d.domain}">
          <span>${domainLabel(d.domain)}</span><span class="count">${d.count}</span>
        </div>`;
      }
      sidebar.innerHTML = sidebarHtml;
      sidebar.querySelectorAll('.domain-item').forEach(el => {
        el.addEventListener('click', () => {
          sidebar.querySelectorAll('.domain-item').forEach(e => e.classList.remove('active'));
          el.classList.add('active');
          currentDomain = el.dataset.domain;
          // sync mobile
          syncMobileDomainActive();
          resetAndLoadItems();
        });
      });

      // Mobile domain chips
      const mobile = document.getElementById('mobile-domain-filters');
      const dc0 = currentDomain === 'All' ? 'active' : '';
      let mobileHtml = `<button class="chip ${dc0} px-3 py-1.5 text-xs font-medium border border-white/[.06] bg-stone-800/50 whitespace-nowrap" data-domain="All">${t().allDomain} (${total})</button>`;
      for (const d of domains) {
        const act = currentDomain === d.domain ? 'active' : '';
        mobileHtml += `<button class="chip ${act} px-3 py-1.5 text-xs font-medium border border-white/[.06] bg-stone-800/50 whitespace-nowrap" data-domain="${d.domain}">${domainLabel(d.domain)} (${d.count})</button>`;
      }
      mobile.innerHTML = mobileHtml;
      mobile.querySelectorAll('.chip').forEach(btn => {
        btn.addEventListener('click', () => {
          mobile.querySelectorAll('.chip').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentDomain = btn.dataset.domain;
          // sync sidebar
          syncSidebarDomainActive();
          resetAndLoadItems();
        });
      });
    }

    function syncSidebarDomainActive() {
      document.querySelectorAll('#sidebar-domains .domain-item').forEach(el => {
        el.classList.toggle('active', el.dataset.domain === currentDomain);
      });
    }

    function syncMobileDomainActive() {
      document.querySelectorAll('#mobile-domain-filters .chip').forEach(el => {
        el.classList.toggle('active', el.dataset.domain === currentDomain);
      });
    }

    function resetAndLoadItems() {
      currentOffset = 0;
      document.getElementById('items-grid').innerHTML = `
        <div class="skeleton h-52"></div><div class="skeleton h-52"></div>
        <div class="skeleton h-52"></div><div class="skeleton h-52"></div>
        <div class="skeleton h-52"></div><div class="skeleton h-52"></div>
      `;
      loadItems(false);
    }

    async function loadItems(append = false) {
      const params = new URLSearchParams();
      if (currentDomain !== 'All') params.set('domain', currentDomain);
      if (currentSearch) params.set('search', currentSearch);
      params.set('sort', currentSort);
      params.set('limit', PAGE_SIZE);
      params.set('offset', currentOffset);

      const resp = await fetch(`/api/items?${params}`);
      const data = await resp.json();
      const items = data.items;
      totalItems = data.total;

      const grid = document.getElementById('items-grid');
      const empty = document.getElementById('empty-state');
      const countEl = document.getElementById('item-count');
      const loadMoreContainer = document.getElementById('load-more-container');
      const shownCountEl = document.getElementById('shown-count');
      const loadMoreBtn = document.getElementById('load-more-btn');

      if (!append && items.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
        loadMoreContainer.classList.add('hidden');
        countEl.textContent = t().itemCount(0);
        return;
      }

      empty.classList.add('hidden');
      countEl.textContent = t().itemCount(totalItems);

      const newHtml = items.map(renderCard).join('');
      if (append) {
        grid.insertAdjacentHTML('beforeend', newHtml);
      } else {
        grid.innerHTML = newHtml;
      }

      const shownSoFar = currentOffset + items.length;
      if (shownSoFar < totalItems) {
        loadMoreContainer.classList.remove('hidden');
        loadMoreBtn.classList.remove('hidden');
        shownCountEl.textContent = t().shownCount(shownSoFar, totalItems);
      } else {
        loadMoreContainer.classList.remove('hidden');
        shownCountEl.textContent = t().shownCount(shownSoFar, totalItems);
        loadMoreBtn.classList.add('hidden');
      }

      if (translateMode && items.length > 0) {
        await translateVisibleCards();
      }
    }

    async function loadMore() {
      currentOffset += PAGE_SIZE;
      await loadItems(true);
    }

    async function loadStats() {
      const resp = await fetch('/api/stats');
      const stats = await resp.json();
      document.getElementById('kpi-raw').textContent = stats.raw_items?.toLocaleString() || '0';
      document.getElementById('kpi-clean').textContent = stats.cleaned_items?.toLocaleString() || '0';
      document.getElementById('kpi-classified').textContent = stats.classified_items?.toLocaleString() || '0';
    }

    // ========== Events ==========
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        currentSearch = e.target.value.trim();
        resetAndLoadItems();
      }, 300);
    });

    document.getElementById('sort-select').addEventListener('change', (e) => {
      currentSort = e.target.value;
      resetAndLoadItems();
    });

    // ========== Init ==========
    applyLang();
    // Default to AI search view - feed data loads lazily on tab switch
  </script>
</body>
</html>
